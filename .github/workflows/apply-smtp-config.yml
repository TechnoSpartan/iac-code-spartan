name: Apply SMTP Configuration to Authelia

on:
  workflow_dispatch:

jobs:
  apply:
    runs-on: ubuntu-latest
    steps:
      - name: Apply SMTP configuration
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_SSH_HOST }}
          username: ${{ secrets.VPS_SSH_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "âœ… APPLYING SMTP CONFIGURATION"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

            # Move uploaded config to correct location
            sudo mv /tmp/authelia-smtp-config.yml /opt/codespartan/platform/authelia/configuration.yml
            sudo chown root:root /opt/codespartan/platform/authelia/configuration.yml

            echo "Configuration applied. Verifying SMTP section:"
            cat /opt/codespartan/platform/authelia/configuration.yml | grep -A 15 "smtp:"

            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "ğŸ”„ RESTARTING AUTHELIA"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

            cd /opt/codespartan/platform/authelia
            docker compose restart authelia

            echo "â³ Waiting 15 seconds for Authelia to restart..."
            sleep 15

            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "ğŸ“Š STATUS CHECK"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

            docker ps --filter "name=authelia" --format "table {{.Names}}\t{{.Status}}"

            echo ""
            echo "ğŸ“‹ Checking for SMTP errors in logs:"
            docker logs authelia --tail 20 | grep -i "smtp\|mail\|notif" || echo "No SMTP-related messages in recent logs"

            echo ""
            echo "âœ… SMTP configuration applied successfully!"
