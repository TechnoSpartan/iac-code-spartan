name: Check Traefik Routers

on:
  workflow_dispatch:

jobs:
  check-routers:
    runs-on: ubuntu-latest
    steps:
      - name: Check Traefik router registration
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_SSH_HOST }}
          username: ${{ secrets.VPS_SSH_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "ğŸ” TRAEFIK API - ROUTERS"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

            echo "All HTTP routers in Traefik:"
            docker exec traefik wget -qO- http://localhost:8080/api/http/routers | python3 -c "
import sys, json
routers = json.load(sys.stdin)
print(f'Total routers: {len(routers)}')
print()
for router in routers:
    name = router.get('name', '')
    print(f'Router: {name}')
    print(f'  Rule: {router.get(\"rule\", \"\")}')
    print(f'  Status: {router.get(\"status\", \"\")}')
    print(f'  Service: {router.get(\"service\", \"\")}')
    print(f'  Priority: {router.get(\"priority\", \"\")}')
    print(f'  EntryPoints: {router.get(\"entryPoints\", [])}')
    print(f'  Using: {router.get(\"using\", [])}')
    print()
" 2>/dev/null || echo "Error parsing routers"

            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "ğŸ”Œ TRAEFIK API - SERVICES"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

            docker exec traefik wget -qO- http://localhost:8080/api/http/services | python3 -c "
import sys, json
services = json.load(sys.stdin)
print(f'Total services: {len(services)}')
print()
for svc in services:
    name = svc.get('name', '')
    print(f'Service: {name}')
    print(f'  Type: {svc.get(\"type\", \"\")}')
    print(f'  Status: {svc.get(\"status\", \"\")}')
    lb = svc.get('loadBalancer', {})
    servers = lb.get('servers', [])
    for server in servers:
        print(f'  Server URL: {server.get(\"url\", \"\")}')
    print()
" 2>/dev/null || echo "Error parsing services"

            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "ğŸ·ï¸  CONTAINER LABELS (ACTUAL)"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

            echo "codespartan-www labels:"
            docker inspect codespartan-www --format='{{range $key, $value := .Config.Labels}}{{$key}}={{$value}}{{"\n"}}{{end}}' 2>/dev/null | grep traefik || echo "No traefik labels found!"

            echo ""
            echo "codespartan-ui labels:"
            docker inspect codespartan-ui --format='{{range $key, $value := .Config.Labels}}{{$key}}={{$value}}{{"\n"}}{{end}}' 2>/dev/null | grep traefik || echo "No traefik labels found!"

            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "ğŸ³ DOCKER PROVIDER STATUS"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

            docker logs traefik --tail 200 2>&1 | grep -E "(codespartan|provider.docker|Configuration received)" | tail -20

            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "ğŸ“Š CONTAINER STATES"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

            docker ps --filter "name=codespartan" --format "table {{.Names}}\t{{.Status}}\t{{.Networks}}"
