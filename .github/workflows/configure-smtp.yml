name: Configure SMTP for Authelia

on:
  workflow_dispatch:

jobs:
  configure:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure SMTP on VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_SSH_HOST }}
          username: ${{ secrets.VPS_SSH_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "ğŸ“§ CONFIGURING SMTP FOR AUTHELIA"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

            # Create backup
            sudo cp /opt/codespartan/platform/authelia/configuration.yml /opt/codespartan/platform/authelia/configuration.yml.smtp-backup

            # Create new configuration with SMTP enabled
            cat > /tmp/authelia_config_smtp.yml << 'EOFCONFIG'
---
###############################################################################
#                           Authelia Configuration                           #
###############################################################################

# FASE 2: Single Sign-On with Multi-Factor Authentication
# This configuration provides centralized authentication for all dashboards

theme: dark

server:
  host: 0.0.0.0
  port: 9091
  path: ""
  enable_pprof: false
  enable_expvars: false

  # Asset path for custom branding (optional - disabled, directory doesn't exist)
  # asset_path: /config/assets/

  # Headers sent to backend
  headers:
    csp_template: ""

log:
  level: info
  format: text
  file_path: /data/authelia.log

# TOTP (Time-based One-Time Password) configuration
totp:
  disable: false
  issuer: mambo-cloud.com
  algorithm: sha1
  digits: 6
  period: 30
  skew: 1
  secret_size: 32

# WebAuthn (hardware keys like YubiKey - optional)
webauthn:
  disable: true  # Set to false if you want to enable hardware keys
  timeout: 60s
  display_name: Mambo Cloud
  attestation_conveyance_preference: indirect
  user_verification: preferred

# Duo Push (optional - requires Duo account)
duo_api:
  disable: true
  hostname: api-XXXXXXXX.duosecurity.com
  integration_key: YOUR_INTEGRATION_KEY
  secret_key: YOUR_SECRET_KEY
  enable_self_enrollment: false

# Identity Validation
identity_validation:
  reset_password:
    jwt_secret: insecure_jwt_secret_please_change_in_production

# Authentication backend
authentication_backend:
  password_reset:
    disable: false
    custom_url: ""

  refresh_interval: 5m

  file:
    path: /config/users_database.yml
    password:
      algorithm: argon2
      argon2:
        variant: argon2id
        iterations: 3
        memory: 65536
        parallelism: 4
        key_length: 32
        salt_length: 16

# Access Control Rules
access_control:
  default_policy: deny

  rules:
    # Allow Authelia portal itself
    - domain: auth.mambo-cloud.com
      policy: bypass

    # Dashboards - require authentication + MFA
    - domain:
        - traefik.mambo-cloud.com
        - grafana.mambo-cloud.com
        - backoffice.mambo-cloud.com
      policy: two_factor
      subject:
        - "group:admins"

    # Public apps - no auth required
    - domain:
        - mambo-cloud.com
        - www.mambo-cloud.com
        - staging.mambo-cloud.com
      policy: bypass

# Session configuration
session:
  name: authelia_session
  domain: mambo-cloud.com
  same_site: lax
  expiration: 1h
  inactivity: 30m
  remember_me_duration: 1M

  redis:
    host: authelia-redis
    port: 6379
    database_index: 0

# Storage backend (SQLite for simplicity)
storage:
  encryption_key: insecure_encryption_key  # CHANGE IN PRODUCTION (min 20 chars)

  local:
    path: /data/db.sqlite3

# Notification Provider
notifier:
  disable_startup_check: false

  # Keep filesystem as fallback (will store copy in file)
  filesystem:
    filename: /data/notifications.txt

  # SMTP configuration (Hostinger)
  smtp:
    host: smtp.hostinger.com
    port: 465
    timeout: 5s
    username: iam@codespartan.es
    password: Codespartan$2
    sender: "Mambo Cloud Auth <noreply@codespartan.es>"
    identifier: mambo-cloud.com
    subject: "[Mambo Cloud] {title}"
    startup_check_address: iam@codespartan.es
    disable_require_tls: false
    disable_html_emails: false
    tls:
      server_name: smtp.hostinger.com
      skip_verify: false

# NTP configuration (for TOTP accuracy)
ntp:
  address: time.cloudflare.com:123
  version: 4
  max_desync: 3s
  disable_startup_check: false
  disable_failure: false
EOFCONFIG

            # Move configuration to correct location
            sudo mv /tmp/authelia_config_smtp.yml /opt/codespartan/platform/authelia/configuration.yml
            sudo chown root:root /opt/codespartan/platform/authelia/configuration.yml

            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "ğŸ“‹ VERIFICATION"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

            echo "SMTP configuration:"
            cat /opt/codespartan/platform/authelia/configuration.yml | grep -A 15 "smtp:"

            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "ğŸ”„ RESTARTING AUTHELIA"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

            cd /opt/codespartan/platform/authelia
            docker compose restart authelia

            echo "â³ Waiting 15 seconds for Authelia to restart..."
            sleep 15

            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "âœ… CONTAINER STATUS"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

            docker ps --filter "name=authelia" --format "table {{.Names}}\t{{.Status}}"

            echo ""
            echo "ğŸ“‹ Last 15 log lines (checking for SMTP errors):"
            docker logs authelia --tail 15
