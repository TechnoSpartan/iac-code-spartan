name: Debug OpenProject Network

on:
  workflow_dispatch:

jobs:
  debug:
    runs-on: ubuntu-latest
    steps:
      - name: Debug network issue
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_SSH_HOST }}
          username: ${{ secrets.VPS_SSH_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -eu pipefail
            
            echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
            echo "üîç DEBUGGING OPENPROJECT NETWORK"
            echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
            
            echo ""
            echo "1Ô∏è‚É£ Checking if network exists:"
            if docker network inspect openproject_internal &>/dev/null 2>&1; then
              echo "  ‚úÖ Network exists"
              
              echo ""
              echo "2Ô∏è‚É£ Network details (raw JSON):"
              docker network inspect openproject_internal 2>&1 || echo "  ‚ö†Ô∏è  Failed to inspect network"
              
              echo ""
              echo "3Ô∏è‚É£ Network labels:"
              docker network inspect openproject_internal --format '{{range $k, $v := .Labels}}{{$k}}={{$v}}{{"\n"}}{{end}}' 2>&1 || echo "  ‚ö†Ô∏è  Failed to get labels"
              
              echo ""
              echo "4Ô∏è‚É£ Checking compose label specifically:"
              NETWORK_LABEL=""
              if NETWORK_LABEL_OUTPUT=$(docker network inspect openproject_internal --format '{{index .Labels "com.docker.compose.network"}}' 2>/dev/null); then
                NETWORK_LABEL="$NETWORK_LABEL_OUTPUT"
              fi
              echo "  Label value: '${NETWORK_LABEL}'"
              echo "  Expected: 'openproject_internal'"
              echo "  Is empty: $([ -z "$NETWORK_LABEL" ] && echo "YES" || echo "NO")"
              
              echo ""
              echo "5Ô∏è‚É£ Testing comparison:"
              if [ -z "$NETWORK_LABEL" ] || [ "$NETWORK_LABEL" != "openproject_internal" ]; then
                echo "  ‚ùå Labels don't match or are missing (will remove)"
              else
                echo "  ‚úÖ Labels match (will keep)"
              fi
              
              echo ""
              echo "6Ô∏è‚É£ Containers using this network:"
              CONTAINERS=""
              if CONTAINERS_OUTPUT=$(docker network inspect openproject_internal --format '{{range .Containers}}{{.Name}} {{end}}' 2>/dev/null); then
                CONTAINERS="$CONTAINERS_OUTPUT"
              fi
              if [ -n "$CONTAINERS" ] && [ "$CONTAINERS" != "" ]; then
                echo "  Containers: $CONTAINERS"
              else
                echo "  No containers using this network"
              fi
              
            else
              echo "  ‚ùå Network does not exist"
            fi
            
            echo ""
            echo "7Ô∏è‚É£ All OpenProject containers:"
            docker ps -a --filter "name=openproject" --format "table {{.Names}}\t{{.Status}}"
            
            echo ""
            echo "8Ô∏è‚É£ Checking project directory:"
            if [ -d "/opt/codespartan/apps/codespartan-cloud/project" ]; then
              echo "  ‚úÖ Directory exists"
              echo "  Files in directory:"
              ls -la /opt/codespartan/apps/codespartan-cloud/project/ | head -15
              
              echo ""
              echo "  Checking docker-compose.yml:"
              if [ -f "/opt/codespartan/apps/codespartan-cloud/project/docker-compose.yml" ]; then
                echo "  ‚úÖ docker-compose.yml exists"
                echo "  Network configuration in docker-compose.yml:"
                grep -A 10 "networks:" /opt/codespartan/apps/codespartan-cloud/project/docker-compose.yml || echo "  ‚ö†Ô∏è  No networks section found"
              else
                echo "  ‚ùå docker-compose.yml not found"
              fi
              
              echo ""
              echo "  Checking .env file:"
              if [ -f "/opt/codespartan/apps/codespartan-cloud/project/.env" ]; then
                echo "  ‚úÖ .env exists"
                echo "  .env file size: $(wc -l < /opt/codespartan/apps/codespartan-cloud/project/.env) lines"
                echo "  (Not showing contents for security)"
              else
                echo "  ‚ö†Ô∏è  .env file not found"
              fi
            else
              echo "  ‚ùå Directory does not exist"
            fi
            
            echo ""
            echo "9Ô∏è‚É£ Testing docker compose command:"
            PROJECT_DIR="/opt/codespartan/apps/codespartan-cloud/project"
            if [ -d "$PROJECT_DIR" ]; then
              if [ -f "$PROJECT_DIR/docker-compose.yml" ]; then
                echo "  Running: docker compose config (validating YAML)"
                cd "$PROJECT_DIR" && docker compose config 2>&1 | head -20 || echo "  ‚ö†Ô∏è  docker compose config failed"
              else
                echo "  ‚ö†Ô∏è  docker-compose.yml not found in $PROJECT_DIR"
              fi
            else
              echo "  ‚ùå Project directory does not exist: $PROJECT_DIR"
            fi
            
            echo ""
            echo "üîü All Docker networks:"
            docker network ls

