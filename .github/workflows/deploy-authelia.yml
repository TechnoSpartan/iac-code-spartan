name: Deploy Authelia (FASE 2 - SSO)

on:
  workflow_dispatch:
  push:
    paths:
      - 'codespartan/platform/authelia/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare Authelia files
        env:
          AUTHELIA_JWT_SECRET: ${{ secrets.AUTHELIA_JWT_SECRET }}
          AUTHELIA_ENCRYPTION_KEY: ${{ secrets.AUTHELIA_ENCRYPTION_KEY }}
          AUTHELIA_SESSION_SECRET: ${{ secrets.AUTHELIA_SESSION_SECRET }}
          AUTHELIA_SMTP_HOST: ${{ secrets.AUTHELIA_SMTP_HOST }}
          AUTHELIA_SMTP_PORT: ${{ secrets.AUTHELIA_SMTP_PORT }}
          AUTHELIA_SMTP_USERNAME: ${{ secrets.AUTHELIA_SMTP_USERNAME }}
          AUTHELIA_SMTP_PASSWORD: ${{ secrets.AUTHELIA_SMTP_PASSWORD }}
          AUTHELIA_SMTP_SENDER: ${{ secrets.AUTHELIA_SMTP_SENDER }}
          AUTHELIA_ADMIN_EMAIL: ${{ secrets.AUTHELIA_ADMIN_EMAIL }}
          AUTHELIA_ADMIN_PASSWORD_HASH: ${{ secrets.AUTHELIA_ADMIN_PASSWORD_HASH }}
        run: |
          mkdir -p artifacts/authelia
          cp -r codespartan/platform/authelia/* artifacts/authelia/

          # Generate configuration.yml from template by substituting secrets
          echo "ğŸ” Generating configuration.yml from template with secrets..."
          envsubst < codespartan/platform/authelia/configuration.yml.template > artifacts/authelia/configuration.yml

          # Verify configuration.yml was created
          if [ ! -f artifacts/authelia/configuration.yml ]; then
            echo "âŒ Failed to generate configuration.yml"
            exit 1
          fi

          # Verify no template variables remain (security check)
          if grep -q '\${' artifacts/authelia/configuration.yml; then
            echo "âš ï¸  WARNING: Template variables still present in configuration.yml"
            grep '\${' artifacts/authelia/configuration.yml
            exit 1
          fi

          echo "âœ… configuration.yml generated successfully"

          # Generate users_database.yml from template
          echo "ğŸ” Generating users_database.yml from template with secrets..."
          envsubst < codespartan/platform/authelia/users_database.yml.template > artifacts/authelia/users_database.yml

          # Verify users_database.yml was created
          if [ ! -f artifacts/authelia/users_database.yml ]; then
            echo "âŒ Failed to generate users_database.yml"
            exit 1
          fi

          # Verify no template variables remain (security check)
          if grep -q '\${' artifacts/authelia/users_database.yml; then
            echo "âš ï¸  WARNING: Template variables still present in users_database.yml"
            grep '\${' artifacts/authelia/users_database.yml
            exit 1
          fi

          echo "âœ… users_database.yml generated successfully"

      - name: Prepare remote directory
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_SSH_HOST }}
          username: ${{ secrets.VPS_SSH_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            mkdir -p /opt/codespartan/platform/authelia

      - name: Copy Authelia files to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_SSH_HOST }}
          username: ${{ secrets.VPS_SSH_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "artifacts/authelia/*"
          target: "/opt/codespartan/platform/authelia/"
          strip_components: 2

      - name: Deploy Authelia on VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_SSH_HOST }}
          username: ${{ secrets.VPS_SSH_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -euo pipefail
            cd /opt/codespartan/platform/authelia

            DEPLOY_START=$(date +%s)

            echo "ğŸš€ FASE 2: Deploying Authelia SSO..."

            # Ensure web network exists
            docker network create web || true

            # Deploy Authelia + Redis
            echo "ğŸ“¦ Starting Authelia and Redis..."
            docker compose up -d

            # Wait for Redis to be healthy
            echo "â³ Waiting for Redis..."
            MAX_ATTEMPTS=30
            ATTEMPT=0

            while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
              REDIS_HEALTH=$(docker inspect --format='{{.State.Health.Status}}' authelia-redis 2>/dev/null || echo "unknown")

              if [ "$REDIS_HEALTH" = "healthy" ]; then
                echo "âœ… Redis is healthy"
                break
              fi

              if [ $ATTEMPT -eq $((MAX_ATTEMPTS - 1)) ]; then
                echo "âŒ Redis failed to become healthy"
                docker logs authelia-redis --tail 30
                exit 1
              fi

              echo -n "."
              ATTEMPT=$((ATTEMPT + 1))
              sleep 2
            done

            # Wait for Authelia to be healthy
            echo "â³ Waiting for Authelia..."
            ATTEMPT=0

            while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
              AUTHELIA_HEALTH=$(docker inspect --format='{{.State.Health.Status}}' authelia 2>/dev/null || echo "unknown")

              if [ "$AUTHELIA_HEALTH" = "healthy" ]; then
                echo "âœ… Authelia is healthy"
                break
              fi

              if [ $ATTEMPT -eq $((MAX_ATTEMPTS - 1)) ]; then
                echo "âŒ Authelia failed to become healthy"
                docker logs authelia --tail 50
                exit 1
              fi

              echo -n "."
              ATTEMPT=$((ATTEMPT + 1))
              sleep 2
            done

            DEPLOY_END=$(date +%s)
            DEPLOY_TIME=$((DEPLOY_END - DEPLOY_START))

            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "âœ¨ Authelia deployed successfully in ${DEPLOY_TIME}s!"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "ğŸ“Š Container status:"
            docker ps --filter "name=authelia" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
            echo ""

      - name: Verify Authelia portal accessibility
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_SSH_HOST }}
          username: ${{ secrets.VPS_SSH_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            echo "ğŸ” Verifying Authelia portal..."
            sleep 5

            # Check if Authelia API is responding
            if curl -f -s -o /dev/null http://localhost:9091/api/health; then
              echo "âœ… Authelia API is accessible (health check passed)"
            else
              echo "âš ï¸  Authelia API health check failed"
              echo "Container may still be initializing..."
            fi

            # Check for errors in logs
            if docker logs authelia 2>&1 | grep -qi "level=error"; then
              echo "âš ï¸  Found errors in Authelia logs:"
              docker logs authelia 2>&1 | grep -i "level=error" | tail -10
            else
              echo "âœ… No errors found in Authelia logs"
            fi

            # Check Redis connection
            if docker logs authelia 2>&1 | grep -qi "session.*redis"; then
              echo "âœ… Authelia connected to Redis"
            fi

            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "ğŸŒ Next Steps:"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "1. Access https://auth.mambo-cloud.com in your browser"
            echo "2. Login with: admin / codespartan123"
            echo "3. Configure MFA (scan QR code with Google Authenticator)"
            echo ""
            echo "âš ï¸  IMPORTANT: Traefik and Grafana are NOT yet protected by Authelia"
            echo "They still use Basic Auth / direct login."
            echo ""
            echo "To complete FASE 2, run these workflows IN ORDER:"
            echo "  1. âœ… deploy-authelia.yml (THIS WORKFLOW - DONE)"
            echo "  2. â³ update-traefik-authelia.yml (NOT CREATED YET)"
            echo "  3. â³ update-grafana-authelia.yml (NOT CREATED YET)"
            echo ""
            echo "Or update manually after verifying Authelia works."
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
