name: Deploy Fail2ban Custom Metrics

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Copy metrics script to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_SSH_HOST }}
          username: ${{ secrets.VPS_SSH_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "codespartan/scripts/fail2ban-metrics.sh"
          target: "/tmp/"
          strip_components: 2

      - name: Copy monitoring config to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_SSH_HOST }}
          username: ${{ secrets.VPS_SSH_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "codespartan/platform/stacks/monitoring/docker-compose.yml,codespartan/platform/stacks/monitoring/victoriametrics/prometheus.yml"
          target: "/tmp/monitoring-update/"
          strip_components: 4

      - name: Deploy Fail2ban metrics solution
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_SSH_HOST }}
          username: ${{ secrets.VPS_SSH_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -e

            echo "üöÄ Deploying Fail2ban Custom Metrics Solution"
            echo "=============================================="

            # Install metrics script
            echo ""
            echo "üìã Installing metrics script..."
            sudo mkdir -p /opt/codespartan/scripts
            sudo cp /tmp/fail2ban-metrics.sh /opt/codespartan/scripts/
            sudo chmod +x /opt/codespartan/scripts/fail2ban-metrics.sh
            sudo chown root:root /opt/codespartan/scripts/fail2ban-metrics.sh

            # Create textfile collector directory
            echo ""
            echo "üìÅ Creating textfile collector directory..."
            sudo mkdir -p /var/lib/node_exporter/textfile_collector
            sudo chmod 755 /var/lib/node_exporter/textfile_collector

            # Run script once to test
            echo ""
            echo "üß™ Testing metrics script..."
            sudo /opt/codespartan/scripts/fail2ban-metrics.sh

            # Verify output file was created
            if [ -f /var/lib/node_exporter/textfile_collector/fail2ban.prom ]; then
                echo "‚úÖ Metrics file created successfully"
                echo ""
                echo "üìä Sample metrics:"
                head -20 /var/lib/node_exporter/textfile_collector/fail2ban.prom
            else
                echo "‚ùå Metrics file was not created"
                exit 1
            fi

            # Setup cron job
            echo ""
            echo "‚è∞ Setting up cron job (runs every minute)..."
            CRON_JOB="* * * * * /opt/codespartan/scripts/fail2ban-metrics.sh 2>&1 | logger -t fail2ban-metrics"

            # Remove old cron job if exists
            if sudo crontab -l 2>/dev/null | grep -q "fail2ban-metrics.sh"; then
                echo "Removing old cron job..."
                sudo crontab -l 2>/dev/null | grep -v "fail2ban-metrics.sh" | sudo crontab - || true
            fi

            # Add new cron job
            (sudo crontab -l 2>/dev/null; echo "$CRON_JOB") | sudo crontab -
            echo "‚úÖ Cron job installed"

            # Verify cron job
            echo ""
            echo "Verifying cron job:"
            sudo crontab -l | grep fail2ban-metrics || echo "‚ö†Ô∏è  Cron job not found"

            # Update monitoring configuration
            echo ""
            echo "üì¶ Updating monitoring configuration..."
            sudo cp /tmp/monitoring-update/docker-compose.yml /opt/codespartan/platform/stacks/monitoring/
            sudo cp /tmp/monitoring-update/prometheus.yml /opt/codespartan/platform/stacks/monitoring/victoriametrics/

            # Stop old fail2ban-exporter if exists
            echo ""
            echo "üõë Stopping old fail2ban-exporter..."
            if docker ps -a | grep -q fail2ban-exporter; then
                docker stop fail2ban-exporter 2>/dev/null || true
                docker rm fail2ban-exporter 2>/dev/null || true
                echo "‚úÖ Old exporter removed"
            else
                echo "No old exporter found"
            fi

            # Update monitoring stack
            echo ""
            echo "üîÑ Updating monitoring stack..."
            cd /opt/codespartan/platform/stacks/monitoring
            docker compose up -d node-exporter

            echo ""
            echo "‚è≥ Waiting for node-exporter to be ready..."
            sleep 10

            # Verify node-exporter is running
            if docker ps | grep -q node-exporter; then
                echo "‚úÖ node-exporter is running"
                docker ps | grep node-exporter
            else
                echo "‚ùå node-exporter is not running"
                exit 1
            fi

            # Restart vmagent to pick up changes
            echo ""
            echo "üîÑ Restarting vmagent..."
            docker restart vmagent
            sleep 5

            echo ""
            echo "‚úÖ Deployment completed!"
            echo "======================"
            echo ""
            echo "üìù Summary:"
            echo "  - Metrics script: /opt/codespartan/scripts/fail2ban-metrics.sh"
            echo "  - Output file: /var/lib/node_exporter/textfile_collector/fail2ban.prom"
            echo "  - Cron job: Every minute"
            echo "  - Collection: via node-exporter textfile collector"
            echo ""
            echo "üîç Verify metrics in node-exporter:"
            echo "  curl -s http://localhost:9100/metrics | grep f2b_"

      - name: Verify metrics in VictoriaMetrics
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_SSH_HOST }}
          username: ${{ secrets.VPS_SSH_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            echo ""
            echo "üîç Verifying metrics collection..."
            echo "=================================="

            # Wait for first scrape
            echo "Waiting 30 seconds for first scrape..."
            sleep 30

            # Check if metrics are available in node-exporter
            echo ""
            echo "üìä Checking node-exporter metrics:"
            curl -s http://localhost:9100/metrics | grep -c "^f2b_" && echo "‚úÖ Fail2ban metrics found in node-exporter" || echo "‚ö†Ô∏è  No metrics yet"

            # Query VictoriaMetrics
            echo ""
            echo "üìä Querying VictoriaMetrics:"
            curl -s "http://localhost:8428/api/v1/query?query=f2b_up" | grep -q '"result":\[' && echo "‚úÖ Metrics found in VictoriaMetrics" || echo "‚ö†Ô∏è  Waiting for scrape (may take up to 30s more)"

            echo ""
            echo "‚úÖ Verification complete!"
            echo ""
            echo "üéØ Next steps:"
            echo "  1. Open Grafana: https://grafana.mambo-cloud.com"
            echo "  2. Go to Explore"
            echo "  3. Query examples:"
            echo "     - f2b_up{jail=\"sshd\"}"
            echo "     - f2b_banned_current"
            echo "     - rate(f2b_failed_total[5m])"
            echo "  4. Create dashboard with fail2ban panels"
