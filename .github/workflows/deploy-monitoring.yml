name: Deploy Monitoring Stack

on:
  workflow_dispatch:
  push:
    paths:
      - 'codespartan/platform/stacks/monitoring/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Prepare files
        run: |
          mkdir -p artifacts/monitoring
          cp -r codespartan/platform/stacks/monitoring/* artifacts/monitoring/

          # Crear archivo .env con configuración de Grafana
          # Nota: Grafana usa OAuth2 de Authelia, no hay usuario admin local
          echo "GRAFANA_HOST=grafana.mambo-cloud.com" > artifacts/monitoring/.env

          echo "✓ Files prepared:"
          ls -la artifacts/monitoring/

      - name: Prepare remote dir
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_SSH_HOST }}
          username: ${{ secrets.VPS_SSH_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            mkdir -p /opt/codespartan/platform/stacks/monitoring

      - name: Copy files to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_SSH_HOST }}
          username: ${{ secrets.VPS_SSH_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "artifacts/monitoring/*"
          target: "/opt/codespartan/platform/stacks/monitoring"
          strip_components: 2

      - name: Deploy on VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_SSH_HOST }}
          username: ${{ secrets.VPS_SSH_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script_stop: true
          script: |
            set -euxo pipefail
            echo "=== System Information ==="
            docker --version
            docker compose version
            df -h /

            echo "=== Preparing deployment ==="
            docker network create web || true

            cd /opt/codespartan/platform/stacks/monitoring
            echo "=== Files in monitoring directory ==="
            ls -la

            echo "=== Pulling images ==="
            docker compose pull

            echo "=== Starting services ==="
            docker compose up -d

            echo "=== Container status ==="
            docker compose ps

            echo "=== Waiting for health checks (30s) ==="
            sleep 30

            echo "=== Verifying container health ==="
            FAILED=0
            for container in $(docker compose ps -q); do
              STATUS=$(docker inspect "$container" --format='{{.State.Health.Status}}' 2>/dev/null || echo "no health check")
              NAME=$(docker inspect "$container" --format='{{.Name}}' | sed 's/\///')
              if [ "$STATUS" = "unhealthy" ]; then
                echo "❌ $NAME is unhealthy"
                docker logs "$container" --tail 20
                FAILED=$((FAILED + 1))
              else
                echo "✅ $NAME is $STATUS"
              fi
            done

            if [ $FAILED -gt 0 ]; then
              echo "❌ $FAILED container(s) failed health check"
              exit 1
            fi

            echo "✅ All containers passed health checks"
