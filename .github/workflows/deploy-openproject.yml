name: Deploy OpenProject

on:
  workflow_dispatch:
  push:
    paths:
      - 'codespartan/apps/codespartan-cloud/project/**'
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Prepare files
        run: |
          mkdir -p artifacts/openproject
          cp -r codespartan/apps/codespartan-cloud/project/* artifacts/openproject/

      - name: Prepare remote directory
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_SSH_HOST }}
          username: ${{ secrets.VPS_SSH_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            mkdir -p /opt/codespartan/apps/codespartan-cloud/project

      - name: Copy files to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_SSH_HOST }}
          username: ${{ secrets.VPS_SSH_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "artifacts/openproject/*"
          target: "/opt/codespartan/apps/codespartan-cloud/project"
          strip_components: 2

      - name: Deploy OpenProject
        uses: appleboy/ssh-action@v1.0.3
        env:
          POSTGRES_PASSWORD: ${{ secrets.OPENPROJECT_POSTGRES_PASSWORD }}
          SECRET_KEY_BASE: ${{ secrets.OPENPROJECT_SECRET_KEY_BASE }}
          SMTP_PASSWORD: ${{ secrets.OPENPROJECT_SMTP_PASSWORD }}
        with:
          host: ${{ secrets.VPS_SSH_HOST }}
          username: ${{ secrets.VPS_SSH_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script_stop: true
          envs: POSTGRES_PASSWORD,SECRET_KEY_BASE,SMTP_PASSWORD
          script: |
            set -eu pipefail

            DEPLOY_START=$(date +%s)

            echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
            echo "üöÄ DEPLOYING OPENPROJECT"
            echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"

            cd /opt/codespartan/apps/codespartan-cloud/project

            # Ensure web network exists (external network for Traefik)
            docker network create web 2>/dev/null || true
            
            # Remove openproject_internal if it exists with incorrect labels
            # Docker Compose will create it with correct labels
            if docker network inspect openproject_internal &>/dev/null 2>&1; then
              echo "‚ö†Ô∏è  Found existing openproject_internal network"
              # Check if network has correct compose label (with error handling)
              NETWORK_LABEL=""
              if NETWORK_LABEL_OUTPUT=$(docker network inspect openproject_internal --format '{{index .Labels "com.docker.compose.network"}}' 2>/dev/null); then
                NETWORK_LABEL="$NETWORK_LABEL_OUTPUT"
              fi
              
              echo "  Network label found: '${NETWORK_LABEL}'"
              
              # Only remove if label is missing or incorrect
              if [ -z "$NETWORK_LABEL" ] || [ "$NETWORK_LABEL" != "openproject_internal" ]; then
                echo "‚ö†Ô∏è  Network has incorrect or missing labels, removing it..."
                # Stop containers using this network first
                CONTAINERS=""
                if CONTAINERS_OUTPUT=$(docker network inspect openproject_internal --format '{{range .Containers}}{{.Name}} {{end}}' 2>/dev/null); then
                  CONTAINERS="$CONTAINERS_OUTPUT"
                fi
                
                if [ -n "$CONTAINERS" ] && [ "$CONTAINERS" != "" ]; then
                  echo "  ‚Üí Stopping containers using this network: $CONTAINERS"
                  for container in $CONTAINERS; do
                    [ -n "$container" ] && docker stop "$container" 2>/dev/null || true
                  done
                fi
                docker network rm openproject_internal 2>/dev/null || true
                echo "‚úÖ Network removed, docker-compose will create it with correct labels"
              else
                echo "‚úÖ Network has correct labels, keeping it"
              fi
            else
              echo "‚ÑπÔ∏è  Network openproject_internal does not exist, docker-compose will create it"
            fi

            # Generate .env with secrets from GitHub
            echo "üîê Generating .env with production secrets..."
            
            # Create .env file using printf to avoid YAML parsing issues
            printf 'TRAEFIK_HOSTNAME=project.codespartan.cloud\n' > .env
            printf 'POSTGRES_DB=openproject\n' >> .env
            printf 'POSTGRES_USER=openproject\n' >> .env
            printf 'POSTGRES_PASSWORD=%s\n' "$POSTGRES_PASSWORD" >> .env
            printf 'OPENPROJECT_HOST__NAME=project.codespartan.cloud\n' >> .env
            printf 'OPENPROJECT_DEFAULT__LANGUAGE=en\n' >> .env
            printf 'OPENPROJECT_SECRET__KEY__BASE=%s\n' "$SECRET_KEY_BASE" >> .env
            printf 'OPENPROJECT_EMAIL__DELIVERY__METHOD=smtp\n' >> .env
            printf 'OPENPROJECT_SMTP__ADDRESS=smtp.hostinger.com\n' >> .env
            printf 'OPENPROJECT_SMTP__PORT=465\n' >> .env
            printf 'OPENPROJECT_SMTP__DOMAIN=codespartan.es\n' >> .env
            printf 'OPENPROJECT_SMTP__AUTHENTICATION=login\n' >> .env
            printf 'OPENPROJECT_SMTP__USER__NAME=noreply@codespartan.es\n' >> .env
            printf 'OPENPROJECT_SMTP__PASSWORD=%s\n' "$SMTP_PASSWORD" >> .env
            printf 'OPENPROJECT_SMTP__ENABLE__STARTTLS=false\n' >> .env
            printf 'DATABASE_URL=postgres://openproject:%s@db:5432/openproject\n' "$POSTGRES_PASSWORD" >> .env
            
            echo "‚úÖ .env created successfully with production secrets"

            # Pull latest images
            echo "üì¶ Pulling latest Docker images..."
            docker compose pull

            # Deploy
            echo "üöÄ Starting OpenProject containers..."
            docker compose up -d

            # Wait for initial setup
            echo "‚è≥ Waiting for containers to start..."
            sleep 5

            # Health checks
            echo "üîç Running health checks..."
            
            # Check database health
            echo "  ‚Üí Checking database..."
            DB_ATTEMPTS=0
            MAX_DB_ATTEMPTS=20
            while [ $DB_ATTEMPTS -lt $MAX_DB_ATTEMPTS ]; do
              if docker exec openproject-db pg_isready -U openproject &>/dev/null; then
                echo "  ‚úÖ Database is ready"
                break
              fi
              echo "  ‚è≥ Waiting for database... ($((DB_ATTEMPTS + 1))/$MAX_DB_ATTEMPTS)"
              DB_ATTEMPTS=$((DB_ATTEMPTS + 1))
              sleep 3
            done

            if [ $DB_ATTEMPTS -eq $MAX_DB_ATTEMPTS ]; then
              echo "  ‚ùå Database failed to start"
              docker logs openproject-db | tail -20
              exit 1
            fi

            # Check app health using Docker health status
            echo "  ‚Üí Checking app..."
            echo "  ‚ÑπÔ∏è  OpenProject can take 5-10 minutes to start (especially first time)"
            echo "  ‚ÑπÔ∏è  Docker health check has 120s start_period + 60s interval"
            
            APP_ATTEMPTS=0
            MAX_APP_ATTEMPTS=60  # 60 attempts * 10s = 10 minutes total
            
            while [ $APP_ATTEMPTS -lt $MAX_APP_ATTEMPTS ]; do
              # Check if container is running
              if ! docker ps --format '{{.Names}}' | grep -q '^openproject-app$'; then
                echo "  ‚ùå Container not running!"
                docker ps -a | grep openproject-app
                echo "üìã Container logs:"
                docker logs --tail 50 openproject-app
                exit 1
              fi
              
              # Get Docker health status (most reliable method)
              CONTAINER_HEALTH=$(docker inspect --format='{{.State.Health.Status}}' openproject-app 2>/dev/null || echo "starting")
              
              # Also check if container is in starting period (health check not running yet)
              CONTAINER_STARTED=$(docker inspect --format='{{.State.StartedAt}}' openproject-app 2>/dev/null)
              CONTAINER_UPTIME=$(($(date +%s) - $(date -d "$CONTAINER_STARTED" +%s 2>/dev/null || echo 0) 2>/dev/null || echo 0))
              
              if [ "$CONTAINER_HEALTH" = "healthy" ]; then
                DEPLOY_END=$(date +%s)
                DEPLOY_TIME=$((DEPLOY_END - DEPLOY_START))

                echo "  ‚úÖ App is healthy (Docker health check passed)"

                # Cleanup old images
                echo "üßπ Cleaning up old images..."
                docker image prune -f

                echo ""
                echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
                echo "‚úÖ DEPLOYMENT SUCCESSFUL (${DEPLOY_TIME}s)"
                echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
                echo ""
                echo "üìä Container Status:"
                docker ps --filter "name=openproject" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

                echo ""
                echo "üåê URL: https://project.codespartan.cloud"
                echo "üë§ Default login: admin / admin"
                echo "‚ö†Ô∏è  IMPORTANT: Change admin password immediately!"
                echo ""
                echo "üìñ First login help: Check README.md in the deployment directory"
                echo ""
                exit 0
              fi
              
              # Show detailed info every 10 attempts
              if [ $((APP_ATTEMPTS % 10)) -eq 0 ]; then
                echo ""
                echo "  üìä Status update:"
                echo "    - Health Status: $CONTAINER_HEALTH"
                echo "    - Container Uptime: ${CONTAINER_UPTIME}s"
                echo "    - Recent logs (last 5 lines):"
                docker logs --tail 5 openproject-app 2>&1 | sed 's/^/      /'
                echo ""
              fi
              
              # Show progress
              if [ $CONTAINER_UPTIME -lt 120 ]; then
                echo "  ‚è≥ Container starting... ($((APP_ATTEMPTS + 1))/$MAX_APP_ATTEMPTS) - Health checks start after 120s (${CONTAINER_UPTIME}s elapsed)"
              else
                echo "  ‚è≥ Waiting for health check... ($((APP_ATTEMPTS + 1))/$MAX_APP_ATTEMPTS) - Status: $CONTAINER_HEALTH"
              fi
              
              APP_ATTEMPTS=$((APP_ATTEMPTS + 1))
              sleep 10  # Check every 10 seconds (more reasonable for long startup)
            done

            echo ""
            echo "  ‚ùå App health check timeout after $((MAX_APP_ATTEMPTS * 10)) seconds"
            echo ""
            echo "üìã Container Status:"
            docker ps -a --filter "name=openproject" --format "table {{.Names}}\t{{.Status}}\t{{.Health}}"
            echo ""
            echo "üìã App container logs (last 100 lines):"
            docker logs --tail 100 openproject-app
            echo ""
            echo "üí° Tip: OpenProject can take 10+ minutes on first startup for database migrations."
            echo "üí° If logs show migrations running, wait longer or check manually:"
            echo "   docker logs openproject-app -f"
            exit 1

      - name: Verify production URL
        if: success()
        run: |
          echo "üåê Verifying production URL..."
          sleep 10

          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://project.codespartan.cloud || echo "000")

          if [ "$HTTP_STATUS" -eq 200 ]; then
            echo "‚úÖ OpenProject is live! (HTTP $HTTP_STATUS)"
            echo "üîó https://project.codespartan.cloud"
            echo ""
            echo "üìù Next steps:"
            echo "1. Login at https://project.codespartan.cloud"
            echo "2. Username: admin"
            echo "3. Password: admin"
            echo "4. Change admin password immediately!"
            echo "5. Configure email settings in Administration"
          else
            echo "‚ö†Ô∏è  Site returned HTTP $HTTP_STATUS"
            if [ "$HTTP_STATUS" -eq "000" ]; then
              echo "DNS may not be resolved yet or SSL certificate is being generated"
            fi
            echo "Container is healthy. Check again in 2-3 minutes: https://project.codespartan.cloud"
          fi
