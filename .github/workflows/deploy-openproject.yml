name: Deploy OpenProject

on:
  workflow_dispatch:
  push:
    paths:
      - 'codespartan/apps/codespartan-cloud/project/**'
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Prepare files
        run: |
          mkdir -p artifacts/openproject
          cp -r codespartan/apps/codespartan-cloud/project/* artifacts/openproject/

      - name: Prepare remote directory
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_SSH_HOST }}
          username: ${{ secrets.VPS_SSH_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            mkdir -p /opt/codespartan/apps/codespartan-cloud/project

      - name: Copy files to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_SSH_HOST }}
          username: ${{ secrets.VPS_SSH_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "artifacts/openproject/*"
          target: "/opt/codespartan/apps/codespartan-cloud/project"
          strip_components: 2

      - name: Deploy OpenProject
        uses: appleboy/ssh-action@v1.0.3
        env:
          POSTGRES_PASSWORD: ${{ secrets.OPENPROJECT_POSTGRES_PASSWORD }}
          SECRET_KEY_BASE: ${{ secrets.OPENPROJECT_SECRET_KEY_BASE }}
          SMTP_PASSWORD: ${{ secrets.OPENPROJECT_SMTP_PASSWORD }}
        with:
          host: ${{ secrets.VPS_SSH_HOST }}
          username: ${{ secrets.VPS_SSH_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script_stop: true
          envs: POSTGRES_PASSWORD,SECRET_KEY_BASE,SMTP_PASSWORD
          script: |
            set -euxo pipefail

            DEPLOY_START=$(date +%s)

            echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
            echo "üöÄ DEPLOYING OPENPROJECT"
            echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"

            cd /opt/codespartan/apps/codespartan-cloud/project

            # Ensure web network exists (external network for Traefik)
            docker network create web 2>/dev/null || true
            
            # Remove openproject_internal if it exists with incorrect labels
            # Docker Compose will create it with correct labels
            if docker network inspect openproject_internal &>/dev/null; then
              echo "‚ö†Ô∏è  Found existing openproject_internal network"
              # Check if network has correct compose label
              NETWORK_LABEL=$(docker network inspect openproject_internal --format '{{index .Labels "com.docker.compose.network"}}' 2>/dev/null || echo "")
              if [ "$NETWORK_LABEL" != "openproject_internal" ]; then
                echo "‚ö†Ô∏è  Network has incorrect labels, removing it..."
                # Stop containers using this network first
                CONTAINERS=$(docker network inspect openproject_internal --format '{{range .Containers}}{{.Name}} {{end}}' 2>/dev/null || echo "")
                if [ -n "$CONTAINERS" ]; then
                  echo "  ‚Üí Stopping containers using this network: $CONTAINERS"
                  for container in $CONTAINERS; do
                    docker stop "$container" 2>/dev/null || true
                  done
                fi
                docker network rm openproject_internal 2>/dev/null || true
                echo "‚úÖ Network removed, docker-compose will create it with correct labels"
              else
                echo "‚úÖ Network has correct labels, keeping it"
              fi
            fi

            # Generate .env with secrets from GitHub
            echo "üîê Generating .env with production secrets..."
            
            # Escape special characters in passwords for sed
            POSTGRES_PASSWORD_ESC=$(printf '%s\n' "$POSTGRES_PASSWORD" | sed 's/[[\.*^$()+?{|]/\\&/g')
            SECRET_KEY_BASE_ESC=$(printf '%s\n' "$SECRET_KEY_BASE" | sed 's/[[\.*^$()+?{|]/\\&/g')
            SMTP_PASSWORD_ESC=$(printf '%s\n' "$SMTP_PASSWORD" | sed 's/[[\.*^$()+?{|]/\\&/g')
            
            # Create .env file using printf to avoid YAML parsing issues
            printf 'TRAEFIK_HOSTNAME=project.codespartan.cloud\n' > .env
            printf 'POSTGRES_DB=openproject\n' >> .env
            printf 'POSTGRES_USER=openproject\n' >> .env
            printf 'POSTGRES_PASSWORD=%s\n' "$POSTGRES_PASSWORD" >> .env
            printf 'OPENPROJECT_HOST__NAME=project.codespartan.cloud\n' >> .env
            printf 'OPENPROJECT_DEFAULT__LANGUAGE=en\n' >> .env
            printf 'OPENPROJECT_SECRET__KEY__BASE=%s\n' "$SECRET_KEY_BASE" >> .env
            printf 'OPENPROJECT_EMAIL__DELIVERY__METHOD=smtp\n' >> .env
            printf 'OPENPROJECT_SMTP__ADDRESS=smtp.hostinger.com\n' >> .env
            printf 'OPENPROJECT_SMTP__PORT=465\n' >> .env
            printf 'OPENPROJECT_SMTP__DOMAIN=codespartan.es\n' >> .env
            printf 'OPENPROJECT_SMTP__AUTHENTICATION=login\n' >> .env
            printf 'OPENPROJECT_SMTP__USER__NAME=noreply@codespartan.es\n' >> .env
            printf 'OPENPROJECT_SMTP__PASSWORD=%s\n' "$SMTP_PASSWORD" >> .env
            printf 'OPENPROJECT_SMTP__ENABLE__STARTTLS=false\n' >> .env
            printf 'DATABASE_URL=postgres://openproject:%s@db:5432/openproject\n' "$POSTGRES_PASSWORD" >> .env
            
            echo "‚úÖ .env created successfully with production secrets"

            # Pull latest images
            echo "üì¶ Pulling latest Docker images..."
            docker compose pull

            # Deploy
            echo "üöÄ Starting OpenProject containers..."
            docker compose up -d

            # Wait for initial setup
            echo "‚è≥ Waiting for containers to start..."
            sleep 5

            # Health checks
            echo "üîç Running health checks..."
            ATTEMPTS=0
            MAX_ATTEMPTS=30

            # Check database health
            echo "  ‚Üí Checking database..."
            while [ $ATTEMPTS -lt $MAX_ATTEMPTS ]; do
              if docker exec openproject-db pg_isready -U openproject &>/dev/null; then
                echo "  ‚úÖ Database is ready"
                break
              fi
              echo "  ‚è≥ Waiting for database... ($((ATTEMPTS + 1))/$MAX_ATTEMPTS)"
              ATTEMPTS=$((ATTEMPTS + 1))
              sleep 3
            done

            if [ $ATTEMPTS -eq $MAX_ATTEMPTS ]; then
              echo "  ‚ùå Database failed to start"
              docker logs openproject-db | tail -20
              exit 1
            fi

            # Check app health
            ATTEMPTS=0
            echo "  ‚Üí Checking app..."
            echo "  ‚ÑπÔ∏è  OpenProject can take 2-5 minutes to start (especially first time)"
            
            while [ $ATTEMPTS -lt $MAX_ATTEMPTS ]; do
              # First check if container is running
              if ! docker ps --format '{{.Names}}' | grep -q '^openproject-app$'; then
                echo "  ‚ö†Ô∏è  Container not running, checking status..."
                docker ps -a | grep openproject-app
                ATTEMPTS=$((ATTEMPTS + 1))
                sleep 3
                continue
              fi
              
              # Check container health status
              CONTAINER_HEALTH=$(docker inspect --format='{{.State.Health.Status}}' openproject-app 2>/dev/null || echo "none")
              
              # Try health check endpoint (curl may not be available, try wget as fallback)
              HEALTH_CHECK_PASSED=false
              
              # Method 1: Try curl
              if docker exec openproject-app curl -sf http://localhost:8080/health_checks/default &>/dev/null 2>&1; then
                HEALTH_CHECK_PASSED=true
              # Method 2: Try wget
              elif docker exec openproject-app wget -q --spider http://localhost:8080/health_checks/default &>/dev/null 2>&1; then
                HEALTH_CHECK_PASSED=true
              # Method 3: Check if port is listening
              elif docker exec openproject-app sh -c "nc -z localhost 8080" &>/dev/null 2>&1; then
                # Port is open, app might be starting
                if [ "$CONTAINER_HEALTH" = "healthy" ]; then
                  HEALTH_CHECK_PASSED=true
                fi
              fi
              
              if [ "$HEALTH_CHECK_PASSED" = "true" ] || [ "$CONTAINER_HEALTH" = "healthy" ]; then
                DEPLOY_END=$(date +%s)
                DEPLOY_TIME=$((DEPLOY_END - DEPLOY_START))

                echo "  ‚úÖ App is healthy"

                # Cleanup old images
                echo "üßπ Cleaning up old images..."
                docker image prune -f

                echo ""
                echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
                echo "‚úÖ DEPLOYMENT SUCCESSFUL (${DEPLOY_TIME}s)"
                echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
                echo ""
                echo "üìä Container Status:"
                docker ps --filter "name=openproject" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

                echo ""
                echo "üåê URL: https://project.codespartan.cloud"
                echo "üë§ Default login: admin / admin"
                echo "‚ö†Ô∏è  IMPORTANT: Change admin password immediately!"
                echo ""
                echo "üìñ First login help: Check README.md in the deployment directory"
                echo ""
                exit 0
              fi
              
              # Show progress with more info every 5 attempts
              if [ $((ATTEMPTS % 5)) -eq 0 ]; then
                echo "  üìã Container status: $CONTAINER_HEALTH"
                echo "  üìã Recent logs (last 3 lines):"
                docker logs --tail 3 openproject-app 2>&1 | sed 's/^/    /'
              fi
              
              echo "  ‚è≥ Waiting for app... ($((ATTEMPTS + 1))/$MAX_ATTEMPTS) (Health: $CONTAINER_HEALTH)"
              ATTEMPTS=$((ATTEMPTS + 1))
              sleep 3
            done

            echo "  ‚ùå App health check timeout after $((MAX_ATTEMPTS * 3)) seconds"
            echo ""
            echo "üìã Container Status:"
            docker ps -a --filter "name=openproject" --format "table {{.Names}}\t{{.Status}}\t{{.Health}}"
            echo ""
            echo "üìã App container logs (last 50 lines):"
            docker logs --tail 50 openproject-app
            echo ""
            echo "üí° Tip: OpenProject can take 5+ minutes on first startup. Check logs above for errors."
            exit 1

      - name: Verify production URL
        if: success()
        run: |
          echo "üåê Verifying production URL..."
          sleep 10

          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://project.codespartan.cloud || echo "000")

          if [ "$HTTP_STATUS" -eq 200 ]; then
            echo "‚úÖ OpenProject is live! (HTTP $HTTP_STATUS)"
            echo "üîó https://project.codespartan.cloud"
            echo ""
            echo "üìù Next steps:"
            echo "1. Login at https://project.codespartan.cloud"
            echo "2. Username: admin"
            echo "3. Password: admin"
            echo "4. Change admin password immediately!"
            echo "5. Configure email settings in Administration"
          else
            echo "‚ö†Ô∏è  Site returned HTTP $HTTP_STATUS"
            if [ "$HTTP_STATUS" -eq "000" ]; then
              echo "DNS may not be resolved yet or SSL certificate is being generated"
            fi
            echo "Container is healthy. Check again in 2-3 minutes: https://project.codespartan.cloud"
          fi
