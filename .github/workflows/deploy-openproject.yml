name: Deploy OpenProject

on:
  workflow_dispatch:
  push:
    paths:
      - 'codespartan/apps/codespartan-cloud/project/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare deployment files
        run: |
          mkdir -p artifacts/openproject
          cp -r codespartan/apps/codespartan-cloud/project/* artifacts/openproject/

      - name: Create remote directory
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_SSH_HOST }}
          username: ${{ secrets.VPS_SSH_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            mkdir -p /opt/codespartan/apps/codespartan-cloud/project

      - name: Copy files to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_SSH_HOST }}
          username: ${{ secrets.VPS_SSH_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "artifacts/openproject/*"
          target: "/opt/codespartan/apps/codespartan-cloud/project"
          strip_components: 2

      - name: Deploy OpenProject with new limits
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_SSH_HOST }}
          username: ${{ secrets.VPS_SSH_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script_stop: true
          script: |
            set -euxo pipefail

            echo "=== Ensuring networks exist ==="
            docker network create web || true
            docker network create openproject_internal || true

            echo "=== Navigating to OpenProject directory ==="
            cd /opt/codespartan/apps/codespartan-cloud/project

            echo "=== Pulling latest images ==="
            docker compose pull

            echo "=== Recreating containers with new memory limits ==="
            # Down and up to apply new resource limits
            docker compose down
            docker compose up -d

            echo "=== Waiting for containers to start ==="
            sleep 10

            echo "=== Verifying containers are running ==="
            docker ps | grep openproject || (echo "ERROR: OpenProject containers not running" && exit 1)

            echo "=== Checking container memory limits ==="
            docker inspect openproject-app --format 'Memory Limit: {{.HostConfig.Memory}} bytes ({{div .HostConfig.Memory 1048576}}MB)' || echo "Warning: Could not check memory limit"
            docker inspect openproject-db --format 'Memory Limit: {{.HostConfig.Memory}} bytes ({{div .HostConfig.Memory 1048576}}MB)' || echo "Warning: Could not check memory limit"
            docker inspect openproject-cache --format 'Memory Limit: {{.HostConfig.Memory}} bytes ({{div .HostConfig.Memory 1048576}}MB)' || echo "Warning: Could not check memory limit"

            echo "âœ… OpenProject deployment completed successfully"

      - name: Verify deployment health
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_SSH_HOST }}
          username: ${{ secrets.VPS_SSH_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -euxo pipefail

            echo "=== Waiting for health checks ==="
            sleep 30

            echo "=== Checking container health status ==="
            docker ps --format "table {{.Names}}\t{{.Status}}" | grep openproject

            echo "=== Checking OpenProject app logs (last 20 lines) ==="
            docker logs openproject-app --tail 20 || echo "Warning: Could not read logs"

            echo "=== Verifying memory limits are applied ==="
            echo "App container:"
            docker inspect openproject-app --format '  Memory Limit: {{.HostConfig.Memory}} bytes' 2>/dev/null | awk '{printf "  %.2f MB\n", $3/1048576}' || echo "  Could not read"
            echo "DB container:"
            docker inspect openproject-db --format '  Memory Limit: {{.HostConfig.Memory}} bytes' 2>/dev/null | awk '{printf "  %.2f MB\n", $3/1048576}' || echo "  Could not read"
            echo "Cache container:"
            docker inspect openproject-cache --format '  Memory Limit: {{.HostConfig.Memory}} bytes' 2>/dev/null | awk '{printf "  %.2f MB\n", $3/1048576}' || echo "  Could not read"
