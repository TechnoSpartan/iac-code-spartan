name: Deploy OpenProject

on:
  workflow_dispatch:
  push:
    paths:
      - 'codespartan/apps/codespartan-cloud/project/**'
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Prepare files
        run: |
          mkdir -p artifacts/openproject
          cp -r codespartan/apps/codespartan-cloud/project/* artifacts/openproject/

      - name: Prepare remote directory
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_SSH_HOST }}
          username: ${{ secrets.VPS_SSH_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            mkdir -p /opt/codespartan/apps/codespartan-cloud/project

      - name: Copy files to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_SSH_HOST }}
          username: ${{ secrets.VPS_SSH_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "artifacts/openproject/*"
          target: "/opt/codespartan/apps/codespartan-cloud/project"
          strip_components: 2

      - name: Deploy OpenProject
        uses: appleboy/ssh-action@v1.0.3
        env:
          POSTGRES_PASSWORD: ${{ secrets.OPENPROJECT_POSTGRES_PASSWORD }}
          SECRET_KEY_BASE: ${{ secrets.OPENPROJECT_SECRET_KEY_BASE }}
          SMTP_PASSWORD: ${{ secrets.OPENPROJECT_SMTP_PASSWORD }}
        with:
          host: ${{ secrets.VPS_SSH_HOST }}
          username: ${{ secrets.VPS_SSH_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script_stop: true
          envs: POSTGRES_PASSWORD,SECRET_KEY_BASE,SMTP_PASSWORD
          script: |
            set -euxo pipefail

            DEPLOY_START=$(date +%s)

            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "ğŸš€ DEPLOYING OPENPROJECT"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

            cd /opt/codespartan/apps/codespartan-cloud/project

            # Ensure web network exists (external network for Traefik)
            docker network create web 2>/dev/null || true
            
            # Remove openproject_internal if it exists with incorrect labels
            # Docker Compose will create it with correct labels
            if docker network inspect openproject_internal &>/dev/null; then
              echo "âš ï¸  Found existing openproject_internal network"
              # Check if network has correct compose label
              NETWORK_LABEL=$(docker network inspect openproject_internal --format '{{index .Labels "com.docker.compose.network"}}' 2>/dev/null || echo "")
              if [ "$NETWORK_LABEL" != "openproject_internal" ]; then
                echo "âš ï¸  Network has incorrect labels, removing it..."
                # Stop containers using this network first
                CONTAINERS=$(docker network inspect openproject_internal --format '{{range .Containers}}{{.Name}} {{end}}' 2>/dev/null || echo "")
                if [ -n "$CONTAINERS" ]; then
                  echo "  â†’ Stopping containers using this network: $CONTAINERS"
                  for container in $CONTAINERS; do
                    docker stop "$container" 2>/dev/null || true
                  done
                fi
                docker network rm openproject_internal 2>/dev/null || true
                echo "âœ… Network removed, docker-compose will create it with correct labels"
              else
                echo "âœ… Network has correct labels, keeping it"
              fi
            fi

            # Generate .env with secrets from GitHub
            echo "ğŸ” Generating .env with production secrets..."
            
            # Escape special characters in passwords for sed
            POSTGRES_PASSWORD_ESC=$(printf '%s\n' "$POSTGRES_PASSWORD" | sed 's/[[\.*^$()+?{|]/\\&/g')
            SECRET_KEY_BASE_ESC=$(printf '%s\n' "$SECRET_KEY_BASE" | sed 's/[[\.*^$()+?{|]/\\&/g')
            SMTP_PASSWORD_ESC=$(printf '%s\n' "$SMTP_PASSWORD" | sed 's/[[\.*^$()+?{|]/\\&/g')
            
            # Create .env file using printf to avoid YAML parsing issues
            printf 'TRAEFIK_HOSTNAME=project.codespartan.cloud\n' > .env
            printf 'POSTGRES_DB=openproject\n' >> .env
            printf 'POSTGRES_USER=openproject\n' >> .env
            printf 'POSTGRES_PASSWORD=%s\n' "$POSTGRES_PASSWORD" >> .env
            printf 'OPENPROJECT_HOST__NAME=project.codespartan.cloud\n' >> .env
            printf 'OPENPROJECT_DEFAULT__LANGUAGE=en\n' >> .env
            printf 'OPENPROJECT_SECRET__KEY__BASE=%s\n' "$SECRET_KEY_BASE" >> .env
            printf 'OPENPROJECT_EMAIL__DELIVERY__METHOD=smtp\n' >> .env
            printf 'OPENPROJECT_SMTP__ADDRESS=smtp.hostinger.com\n' >> .env
            printf 'OPENPROJECT_SMTP__PORT=465\n' >> .env
            printf 'OPENPROJECT_SMTP__DOMAIN=codespartan.es\n' >> .env
            printf 'OPENPROJECT_SMTP__AUTHENTICATION=login\n' >> .env
            printf 'OPENPROJECT_SMTP__USER__NAME=noreply@codespartan.es\n' >> .env
            printf 'OPENPROJECT_SMTP__PASSWORD=%s\n' "$SMTP_PASSWORD" >> .env
            printf 'OPENPROJECT_SMTP__ENABLE__STARTTLS=false\n' >> .env
            printf 'DATABASE_URL=postgres://openproject:%s@db:5432/openproject\n' "$POSTGRES_PASSWORD" >> .env
            
            echo "âœ… .env created successfully with production secrets"

            # Pull latest images
            echo "ğŸ“¦ Pulling latest Docker images..."
            docker compose pull

            # Deploy
            echo "ğŸš€ Starting OpenProject containers..."
            docker compose up -d

            # Wait for initial setup
            echo "â³ Waiting for containers to start..."
            sleep 5

            # Health checks
            echo "ğŸ” Running health checks..."
            ATTEMPTS=0
            MAX_ATTEMPTS=30

            # Check database health
            echo "  â†’ Checking database..."
            while [ $ATTEMPTS -lt $MAX_ATTEMPTS ]; do
              if docker exec openproject-db pg_isready -U openproject &>/dev/null; then
                echo "  âœ… Database is ready"
                break
              fi
              echo "  â³ Waiting for database... ($((ATTEMPTS + 1))/$MAX_ATTEMPTS)"
              ATTEMPTS=$((ATTEMPTS + 1))
              sleep 3
            done

            if [ $ATTEMPTS -eq $MAX_ATTEMPTS ]; then
              echo "  âŒ Database failed to start"
              docker logs openproject-db | tail -20
              exit 1
            fi

            # Check app health
            ATTEMPTS=0
            echo "  â†’ Checking app..."
            while [ $ATTEMPTS -lt $MAX_ATTEMPTS ]; do
              if docker exec openproject-app curl -sf http://localhost:8080/health_checks/default &>/dev/null; then
                DEPLOY_END=$(date +%s)
                DEPLOY_TIME=$((DEPLOY_END - DEPLOY_START))

                echo "  âœ… App is healthy"

                # Cleanup old images
                echo "ğŸ§¹ Cleaning up old images..."
                docker image prune -f

                echo ""
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                echo "âœ… DEPLOYMENT SUCCESSFUL (${DEPLOY_TIME}s)"
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                echo ""
                echo "ğŸ“Š Container Status:"
                docker ps --filter "name=openproject" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

                echo ""
                echo "ğŸŒ URL: https://project.codespartan.cloud"
                echo "ğŸ‘¤ Default login: admin / admin"
                echo "âš ï¸  IMPORTANT: Change admin password immediately!"
                echo ""
                echo "ğŸ“– First login help: Check README.md in the deployment directory"
                echo ""
                exit 0
              fi
              echo "  â³ Waiting for app... ($((ATTEMPTS + 1))/$MAX_ATTEMPTS)"
              ATTEMPTS=$((ATTEMPTS + 1))
              sleep 3
            done

            echo "  âŒ App health check timeout"
            echo "ğŸ“‹ App container logs:"
            docker logs --tail 50 openproject-app
            exit 1

      - name: Verify production URL
        if: success()
        run: |
          echo "ğŸŒ Verifying production URL..."
          sleep 10

          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://project.codespartan.cloud || echo "000")

          if [ "$HTTP_STATUS" -eq 200 ]; then
            echo "âœ… OpenProject is live! (HTTP $HTTP_STATUS)"
            echo "ğŸ”— https://project.codespartan.cloud"
            echo ""
            echo "ğŸ“ Next steps:"
            echo "1. Login at https://project.codespartan.cloud"
            echo "2. Username: admin"
            echo "3. Password: admin"
            echo "4. Change admin password immediately!"
            echo "5. Configure email settings in Administration"
          else
            echo "âš ï¸  Site returned HTTP $HTTP_STATUS"
            if [ "$HTTP_STATUS" -eq "000" ]; then
              echo "DNS may not be resolved yet or SSL certificate is being generated"
            fi
            echo "Container is healthy. Check again in 2-3 minutes: https://project.codespartan.cloud"
          fi
