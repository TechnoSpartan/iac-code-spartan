name: Deploy OpenProject

on:
  workflow_dispatch:
  push:
    paths:
      - 'codespartan/apps/codespartan-cloud/project/**'
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Prepare files
        run: |
          mkdir -p artifacts/openproject
          cp -r codespartan/apps/codespartan-cloud/project/* artifacts/openproject/

      - name: Prepare remote directory
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_SSH_HOST }}
          username: ${{ secrets.VPS_SSH_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            mkdir -p /opt/codespartan/apps/codespartan-cloud/project

      - name: Copy files to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_SSH_HOST }}
          username: ${{ secrets.VPS_SSH_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "artifacts/openproject/*"
          target: "/opt/codespartan/apps/codespartan-cloud/project"
          strip_components: 2

      - name: Deploy OpenProject
        uses: appleboy/ssh-action@v1.0.3
        env:
          POSTGRES_PASSWORD: ${{ secrets.OPENPROJECT_POSTGRES_PASSWORD }}
          SECRET_KEY_BASE: ${{ secrets.OPENPROJECT_SECRET_KEY_BASE }}
          SMTP_PASSWORD: ${{ secrets.OPENPROJECT_SMTP_PASSWORD }}
        with:
          host: ${{ secrets.VPS_SSH_HOST }}
          username: ${{ secrets.VPS_SSH_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script_stop: true
          envs: POSTGRES_PASSWORD,SECRET_KEY_BASE,SMTP_PASSWORD
          script: |
            set -euxo pipefail

            DEPLOY_START=$(date +%s)

            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "ğŸš€ DEPLOYING OPENPROJECT"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

            cd /opt/codespartan/apps/codespartan-cloud/project

            # Ensure networks exist (suppress errors if already exist)
            docker network create web 2>/dev/null || true
            docker network create openproject_internal 2>/dev/null || true

            # Generate .env with secrets from GitHub
            echo "ğŸ” Generating .env with production secrets..."
            cat > .env << 'EOF'
            TRAEFIK_HOSTNAME=project.codespartan.cloud
            POSTGRES_DB=openproject
            POSTGRES_USER=openproject
            POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
            OPENPROJECT_HOST__NAME=project.codespartan.cloud
            OPENPROJECT_DEFAULT__LANGUAGE=en
            OPENPROJECT_SECRET__KEY__BASE=${SECRET_KEY_BASE}
            OPENPROJECT_EMAIL__DELIVERY__METHOD=smtp
            OPENPROJECT_SMTP__ADDRESS=smtp.hostinger.com
            OPENPROJECT_SMTP__PORT=465
            OPENPROJECT_SMTP__DOMAIN=codespartan.es
            OPENPROJECT_SMTP__AUTHENTICATION=login
            OPENPROJECT_SMTP__USER__NAME=noreply@codespartan.es
            OPENPROJECT_SMTP__PASSWORD=${SMTP_PASSWORD}
            OPENPROJECT_SMTP__ENABLE__STARTTLS=false
            DATABASE_URL=postgres://openproject:${POSTGRES_PASSWORD}@db:5432/openproject
            EOF
            eval "sed -i \"s/\\\${POSTGRES_PASSWORD}/$POSTGRES_PASSWORD/g\" .env"
            eval "sed -i \"s/\\\${SECRET_KEY_BASE}/$SECRET_KEY_BASE/g\" .env"
            eval "sed -i \"s/\\\${SMTP_PASSWORD}/$SMTP_PASSWORD/g\" .env"
            echo "âœ… .env created successfully with production secrets"

            # Pull latest images
            echo "ğŸ“¦ Pulling latest Docker images..."
            docker compose pull

            # Deploy
            echo "ğŸš€ Starting OpenProject containers..."
            docker compose up -d

            # Wait for initial setup
            echo "â³ Waiting for containers to start..."
            sleep 5

            # Health checks
            echo "ğŸ” Running health checks..."
            ATTEMPTS=0
            MAX_ATTEMPTS=30

            # Check database health
            echo "  â†’ Checking database..."
            while [ $ATTEMPTS -lt $MAX_ATTEMPTS ]; do
              if docker exec openproject-db pg_isready -U openproject &>/dev/null; then
                echo "  âœ… Database is ready"
                break
              fi
              echo "  â³ Waiting for database... ($((ATTEMPTS + 1))/$MAX_ATTEMPTS)"
              ATTEMPTS=$((ATTEMPTS + 1))
              sleep 3
            done

            if [ $ATTEMPTS -eq $MAX_ATTEMPTS ]; then
              echo "  âŒ Database failed to start"
              docker logs openproject-db | tail -20
              exit 1
            fi

            # Check app health
            ATTEMPTS=0
            echo "  â†’ Checking app..."
            while [ $ATTEMPTS -lt $MAX_ATTEMPTS ]; do
              if docker exec openproject-app curl -sf http://localhost:8080/health_checks/default &>/dev/null; then
                DEPLOY_END=$(date +%s)
                DEPLOY_TIME=$((DEPLOY_END - DEPLOY_START))

                echo "  âœ… App is healthy"

                # Cleanup old images
                echo "ğŸ§¹ Cleaning up old images..."
                docker image prune -f

                echo ""
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                echo "âœ… DEPLOYMENT SUCCESSFUL (${DEPLOY_TIME}s)"
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                echo ""
                echo "ğŸ“Š Container Status:"
                docker ps --filter "name=openproject" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

                echo ""
                echo "ğŸŒ URL: https://project.codespartan.cloud"
                echo "ğŸ‘¤ Default login: admin / admin"
                echo "âš ï¸  IMPORTANT: Change admin password immediately!"
                echo ""
                echo "ğŸ“– First login help: Check README.md in the deployment directory"
                echo ""
                exit 0
              fi
              echo "  â³ Waiting for app... ($((ATTEMPTS + 1))/$MAX_ATTEMPTS)"
              ATTEMPTS=$((ATTEMPTS + 1))
              sleep 3
            done

            echo "  âŒ App health check timeout"
            echo "ğŸ“‹ App container logs:"
            docker logs --tail 50 openproject-app
            exit 1

      - name: Verify production URL
        if: success()
        run: |
          echo "ğŸŒ Verifying production URL..."
          sleep 10

          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://project.codespartan.cloud || echo "000")

          if [ "$HTTP_STATUS" -eq 200 ]; then
            echo "âœ… OpenProject is live! (HTTP $HTTP_STATUS)"
            echo "ğŸ”— https://project.codespartan.cloud"
            echo ""
            echo "ğŸ“ Next steps:"
            echo "1. Login at https://project.codespartan.cloud"
            echo "2. Username: admin"
            echo "3. Password: admin"
            echo "4. Change admin password immediately!"
            echo "5. Configure email settings in Administration"
          else
            echo "âš ï¸  Site returned HTTP $HTTP_STATUS"
            if [ "$HTTP_STATUS" -eq "000" ]; then
              echo "DNS may not be resolved yet or SSL certificate is being generated"
            fi
            echo "Container is healthy. Check again in 2-3 minutes: https://project.codespartan.cloud"
          fi
