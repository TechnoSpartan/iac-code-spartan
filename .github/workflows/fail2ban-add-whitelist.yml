name: Fail2ban Add IP to Whitelist

on:
  workflow_dispatch:
    inputs:
      ip_address:
        description: 'IP address to add to whitelist'
        required: true
        type: string

jobs:
  add-whitelist:
    runs-on: ubuntu-latest
    steps:
      - name: Add IP to Fail2ban Whitelist
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_SSH_HOST }}
          username: ${{ secrets.VPS_SSH_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -euxo pipefail

            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "ğŸ›¡ï¸  ADDING IP TO FAIL2BAN WHITELIST"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""

            IP_ADDRESS="${{ inputs.ip_address }}"

            if [ -z "$IP_ADDRESS" ]; then
              echo "âŒ Error: IP address not provided"
              exit 1
            fi

            # Validate IP format (basic)
            if ! [[ $IP_ADDRESS =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]] && [ "$IP_ADDRESS" != "all" ]; then
              echo "âš ï¸  Warning: IP format may be invalid: $IP_ADDRESS"
              echo "Continuing anyway..."
            fi

            echo "ğŸ“ Adding IP to whitelist: $IP_ADDRESS"
            echo ""

            # Check if Fail2ban is running
            if ! systemctl is-active --quiet fail2ban; then
              echo "âš ï¸  Fail2ban is not running. Starting it..."
              sudo systemctl start fail2ban
              sleep 2
            fi

            # Add IP to whitelist temporarily (without restart)
            echo "ğŸ”„ Adding IP to whitelist (temporary)..."
            for jail in $(sudo fail2ban-client status | grep "Jail list:" | sed 's/.*:\s*//' | tr ',' ' '); do
              echo "  Adding to jail: $jail"
              sudo fail2ban-client set $jail addignoreip $IP_ADDRESS 2>/dev/null || {
                echo "  âš ï¸  Failed to add to $jail (may already be in whitelist)"
              }
            done
            echo ""

            # Add IP to configuration file permanently
            echo "ğŸ“ Adding IP to configuration file (permanent)..."
            if [ -f /etc/fail2ban/jail.local ]; then
              # Check if IP is already in config
              if grep -q "$IP_ADDRESS" /etc/fail2ban/jail.local; then
                echo "âœ… IP already in configuration file"
              else
                # Create backup
                sudo cp /etc/fail2ban/jail.local /etc/fail2ban/jail.local.backup.$(date +%Y%m%d_%H%M%S)
                
                # Add IP to ignoreip lines
                sudo sed -i "s/ignoreip = \(.*\)/ignoreip = \1 $IP_ADDRESS/" /etc/fail2ban/jail.local
                
                echo "âœ… IP added to configuration file"
                
                # Restart Fail2ban to apply permanent changes
                echo "ğŸ”„ Restarting Fail2ban to apply permanent changes..."
                sudo systemctl restart fail2ban
                sleep 2
              fi
            else
              echo "âš ï¸  Configuration file /etc/fail2ban/jail.local not found"
              echo "Creating new configuration..."
              # This should not happen if Fail2ban was installed correctly
            fi

            echo ""
            echo "ğŸ“Š Verifying whitelist..."
            for jail in $(sudo fail2ban-client status | grep "Jail list:" | sed 's/.*:\s*//' | tr ',' ' '); do
              echo "Jail: $jail"
              sudo fail2ban-client get $jail ignoreip 2>/dev/null || echo "  (no ignoreip configured)"
              echo ""
            done

            echo "âœ… IP $IP_ADDRESS has been added to whitelist"
            echo ""
            echo "ğŸ“‹ This IP will now be ignored by Fail2ban and will NOT be banned"
            echo ""

            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

