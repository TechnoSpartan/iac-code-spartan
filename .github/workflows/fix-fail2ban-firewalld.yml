name: Fix Fail2ban - Activate FirewallD

on:
  workflow_dispatch:

jobs:
  fix-fail2ban:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fix Fail2ban on VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_SSH_HOST }}
          username: ${{ secrets.VPS_SSH_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -e

            echo "ğŸ”§ Fixing Fail2ban Configuration"
            echo "=================================="

            # Check current state
            echo ""
            echo "ğŸ“Š Current State:"
            echo "----------------"
            sudo systemctl is-active firewalld && echo "âœ… FirewallD: active" || echo "âŒ FirewallD: inactive"
            sudo systemctl is-active fail2ban && echo "âœ… Fail2ban: active" || echo "âŒ Fail2ban: inactive"

            # Activate FirewallD
            echo ""
            echo "ğŸ”¥ Activating FirewallD..."
            sudo systemctl start firewalld
            sudo systemctl enable firewalld

            # Configure basic rules (allow SSH, HTTP, HTTPS)
            echo ""
            echo "âš™ï¸  Configuring firewall rules..."
            sudo firewall-cmd --permanent --add-service=ssh
            sudo firewall-cmd --permanent --add-service=http
            sudo firewall-cmd --permanent --add-service=https
            sudo firewall-cmd --permanent --add-service=dns

            # Allow ICMP (ping)
            sudo firewall-cmd --permanent --add-icmp-block-inversion

            # Reload firewall
            sudo firewall-cmd --reload

            echo "âœ… FirewallD configured and active"

            # Restart Fail2ban to pick up firewalld
            echo ""
            echo "ğŸ”„ Restarting Fail2ban..."
            sudo systemctl restart fail2ban

            # Wait for services to stabilize
            sleep 5

            # Verify everything is working
            echo ""
            echo "âœ… Verification:"
            echo "---------------"
            sudo systemctl status firewalld --no-pager | head -5
            echo ""
            sudo systemctl status fail2ban --no-pager | head -5
            echo ""
            sudo fail2ban-client status
            echo ""
            sudo fail2ban-client status sshd || echo "âš ï¸  SSHD jail not active yet"
            echo ""

            # Restart fail2ban-exporter container
            echo ""
            echo "ğŸ”„ Restarting fail2ban-exporter..."
            docker restart fail2ban-exporter
            sleep 3
            docker ps | grep fail2ban-exporter

            echo ""
            echo "âœ… Fail2ban fix completed!"
            echo "=========================="
            echo ""
            echo "ğŸ“ Summary:"
            echo "  - FirewallD: ACTIVE and ENABLED"
            echo "  - Fail2ban: RUNNING"
            echo "  - SSH Jail: CONFIGURED"
            echo "  - Exporter: RESTARTED"
            echo ""
            echo "ğŸ” Monitor with:"
            echo "  sudo fail2ban-client status"
            echo "  sudo firewall-cmd --list-all"
            echo "  docker logs fail2ban-exporter"

      - name: Wait and verify exporter
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_SSH_HOST }}
          username: ${{ secrets.VPS_SSH_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            echo ""
            echo "ğŸ§ª Testing fail2ban-exporter..."
            echo "==============================="
            sleep 5

            # Check if exporter is healthy
            if docker ps | grep -q "fail2ban-exporter.*healthy"; then
              echo "âœ… fail2ban-exporter is HEALTHY"

              # Try to get metrics
              echo ""
              echo "ğŸ“Š Sample metrics:"
              docker exec fail2ban-exporter wget -q -O- http://localhost:9921/metrics 2>&1 | head -20 || echo "âš ï¸  Could not fetch metrics"
            else
              echo "âŒ fail2ban-exporter is NOT healthy"
              echo ""
              echo "ğŸ“‹ Container logs:"
              docker logs fail2ban-exporter --tail 30
            fi
