name: Fix Traefik Docker Container Discovery

on:
  workflow_dispatch:

jobs:
  fix:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ” DiagnÃ³stico completo y soluciÃ³n
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_SSH_HOST }}
          username: ${{ secrets.VPS_SSH_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set +e  # Permitir errores para manejo manual
            
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "ğŸ” DIAGNÃ“STICO COMPLETO - TRAEFIK DISCOVERY"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            
            # 1. Verificar docker-socket-proxy
            echo ""
            echo "1ï¸âƒ£ Verificando docker-socket-proxy..."
            if docker ps --filter "name=docker-socket-proxy" --format "{{.Names}}" | grep -q "docker-socket-proxy"; then
              echo "âœ… docker-socket-proxy estÃ¡ corriendo"
              docker ps --filter "name=docker-socket-proxy" --format "table {{.Names}}\t{{.Status}}\t{{.Networks}}"
            else
              echo "âŒ docker-socket-proxy NO estÃ¡ corriendo"
              echo "ğŸš€ Desplegando docker-socket-proxy..."
              
              # Verificar que existe el directorio
              if [ ! -d "/opt/codespartan/platform/docker-socket-proxy" ]; then
                echo "âŒ Directorio no existe. Necesitas desplegar docker-socket-proxy primero."
                exit 1
              fi
              
              cd /opt/codespartan/platform/docker-socket-proxy
              docker compose up -d
              
              # Esperar a que estÃ© healthy
              echo "â³ Esperando a que docker-socket-proxy estÃ© healthy..."
              for i in {1..30}; do
                if docker inspect --format='{{.State.Health.Status}}' docker-socket-proxy 2>/dev/null | grep -q "healthy"; then
                  echo "âœ… docker-socket-proxy estÃ¡ healthy"
                  break
                fi
                if [ $i -eq 30 ]; then
                  echo "âš ï¸ docker-socket-proxy no pasÃ³ el health check, pero continuamos..."
                fi
                sleep 2
              done
            fi
            
            # 2. Verificar red docker_api
            echo ""
            echo "2ï¸âƒ£ Verificando red docker_api..."
            if docker network inspect docker_api >/dev/null 2>&1; then
              echo "âœ… Red docker_api existe"
              echo "Contenedores en docker_api:"
              docker network inspect docker_api --format='{{range .Containers}}{{.Name}}: {{.IPv4Address}}{{"\n"}}{{end}}' || echo "Ninguno"
            else
              echo "âŒ Red docker_api NO existe"
              echo "ğŸš€ Creando red docker_api..."
              docker network create docker_api || echo "âš ï¸ La red ya existe (ignorando error)"
            fi
            
            # 3. Verificar que Traefik estÃ¡ en docker_api
            echo ""
            echo "3ï¸âƒ£ Verificando que Traefik estÃ¡ en red docker_api..."
            if docker network inspect docker_api --format='{{range .Containers}}{{.Name}}{{"\n"}}{{end}}' | grep -q "traefik"; then
              echo "âœ… Traefik estÃ¡ en docker_api"
            else
              echo "âŒ Traefik NO estÃ¡ en docker_api"
              echo "ğŸ”— Conectando Traefik a docker_api..."
              docker network connect docker_api traefik || echo "âš ï¸ Error conectando (puede que ya estÃ© conectado)"
            fi
            
            # 4. Verificar que docker-socket-proxy estÃ¡ en docker_api
            echo ""
            echo "4ï¸âƒ£ Verificando que docker-socket-proxy estÃ¡ en red docker_api..."
            if docker network inspect docker_api --format='{{range .Containers}}{{.Name}}{{"\n"}}{{end}}' | grep -q "docker-socket-proxy"; then
              echo "âœ… docker-socket-proxy estÃ¡ en docker_api"
            else
              echo "âŒ docker-socket-proxy NO estÃ¡ en docker_api"
              echo "ğŸ”— Conectando docker-socket-proxy a docker_api..."
              docker network connect docker_api docker-socket-proxy || echo "âš ï¸ Error conectando (puede que ya estÃ© conectado)"
            fi
            
            # 5. Test de conectividad desde Traefik al proxy
            echo ""
            echo "5ï¸âƒ£ Test de conectividad Traefik â†’ docker-socket-proxy..."
            if docker exec traefik wget -qO- --timeout=5 http://docker-socket-proxy:2375/version 2>&1 | head -5; then
              echo "âœ… Traefik puede conectarse al proxy"
            else
              echo "âŒ Traefik NO puede conectarse al proxy"
              echo "âš ï¸ Esto puede ser normal si el proxy no responde a /version"
            fi
            
            # 6. Verificar contenedores codespartan
            echo ""
            echo "6ï¸âƒ£ Verificando contenedores codespartan..."
            docker ps --filter "name=codespartan" --format "table {{.Names}}\t{{.Status}}\t{{.Networks}}"
            
            # 7. Verificar labels de Traefik en los contenedores
            echo ""
            echo "7ï¸âƒ£ Verificando labels de Traefik..."
            for container in codespartan-www codespartan-ui; do
              if docker ps --format "{{.Names}}" | grep -q "$container"; then
                echo "Labels de $container:"
                docker inspect "$container" --format='{{range $k, $v := .Config.Labels}}{{$k}}={{$v}}{{"\n"}}{{end}}' | grep traefik || echo "  âš ï¸ No se encontraron labels de Traefik"
              fi
            done
            
            # 8. Verificar routers en Traefik API
            echo ""
            echo "8ï¸âƒ£ Verificando routers registrados en Traefik..."
            if docker exec traefik wget -qO- http://localhost:8080/api/http/routers 2>/dev/null | python3 -c "
            import sys, json
            try:
              routers = json.load(sys.stdin)
              print(f'Total routers: {len(routers)}')
              for r in routers:
                if 'codespartan' in r.get('name', '').lower():
                  print(f\"  âœ… {r.get('name')}: {r.get('status', 'unknown')}\")
            except:
              print('Error parseando routers')
            " 2>&1; then
              echo ""
            else
              echo "âš ï¸ No se pudieron obtener los routers"
            fi
            
            # 9. Reiniciar Traefik para forzar rediscovery
            echo ""
            echo "9ï¸âƒ£ Reiniciando Traefik para forzar rediscovery..."
            cd /opt/codespartan/platform/traefik
            docker compose restart traefik
            
            echo "â³ Esperando a que Traefik se reinicie..."
            sleep 10
            
            # 10. Verificar logs de Traefik
            echo ""
            echo "ğŸ”Ÿ Ãšltimos logs de Traefik (Docker provider):"
            docker logs traefik --tail 30 2>&1 | grep -i "docker\|provider" | tail -10 || echo "No hay logs relevantes"
            
            # 11. Verificar routers despuÃ©s del reinicio
            echo ""
            echo "1ï¸âƒ£1ï¸âƒ£ Verificando routers despuÃ©s del reinicio..."
            sleep 5
            if docker exec traefik wget -qO- http://localhost:8080/api/http/routers 2>/dev/null | python3 -c "
            import sys, json
            try:
              routers = json.load(sys.stdin)
              codespartan_routers = [r for r in routers if 'codespartan' in r.get('name', '').lower()]
              print(f'Routers codespartan encontrados: {len(codespartan_routers)}')
              for r in codespartan_routers:
                print(f\"  - {r.get('name')}: {r.get('status', 'unknown')}\")
              if len(codespartan_routers) == 0:
                print('  âš ï¸ No se encontraron routers de codespartan')
            except Exception as e:
              print(f'Error: {e}')
            " 2>&1; then
              echo ""
            fi
            
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "âœ… DIAGNÃ“STICO COMPLETADO"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "ğŸ“‹ Resumen:"
            echo "  - docker-socket-proxy: $(docker ps --filter 'name=docker-socket-proxy' --format '{{.Status}}' || echo 'NO CORRIENDO')"
            echo "  - Traefik: $(docker ps --filter 'name=traefik' --format '{{.Status}}' || echo 'NO CORRIENDO')"
            echo "  - codespartan-www: $(docker ps --filter 'name=codespartan-www' --format '{{.Status}}' || echo 'NO CORRIENDO')"
            echo "  - codespartan-ui: $(docker ps --filter 'name=codespartan-ui' --format '{{.Status}}' || echo 'NO CORRIENDO')"
            echo ""
            echo "ğŸ§ª Prueba manual:"
            echo "  curl -Ik https://www.codespartan.cloud"
            echo "  curl -Ik https://ui.codespartan.cloud"

