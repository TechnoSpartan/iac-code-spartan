name: Install/Verify Fail2ban

on:
  workflow_dispatch:
    inputs:
      force_reinstall:
        description: 'Force reinstall even if already installed'
        type: boolean
        default: false

jobs:
  install:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install/Verify Fail2ban
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_SSH_HOST }}
          username: ${{ secrets.VPS_SSH_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -euxo pipefail

            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "ğŸ›¡ï¸  INSTALLING/VERIFYING FAIL2BAN"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""

            # Detect distribution
            if [ -f /etc/redhat-release ]; then
              DISTRO="rhel"
              echo "ğŸ“¦ Detected: RHEL-based (AlmaLinux/RHEL/CentOS)"
              cat /etc/redhat-release
            elif [ -f /etc/debian_version ]; then
              DISTRO="debian"
              echo "ğŸ“¦ Detected: Debian-based (Debian/Ubuntu)"
              cat /etc/debian_version
            else
              echo "âŒ Unsupported distribution"
              exit 1
            fi
            echo ""

            # Check if Fail2ban is already installed
            if command -v fail2ban-client &> /dev/null; then
              echo "âœ… Fail2ban ya estÃ¡ instalado"
              fail2ban-client --version
              
              if [ "${{ inputs.force_reinstall }}" = "true" ]; then
                echo "ğŸ”„ Force reinstall activado, reinstalando..."
              else
                echo "â„¹ï¸  Para reinstalar, activa 'force_reinstall' en el workflow"
                echo ""
              fi
            fi

            # Install Fail2ban if not installed or force_reinstall is true
            if ! command -v fail2ban-client &> /dev/null || [ "${{ inputs.force_reinstall }}" = "true" ]; then
              echo "ğŸ“¦ Instalando Fail2ban..."
              
              if [ "$DISTRO" = "rhel" ]; then
                # Install EPEL if not present
                if ! rpm -q epel-release >/dev/null 2>&1; then
                  echo "ğŸ“¦ Instalando repositorio EPEL..."
                  sudo dnf install -y epel-release
                fi
                sudo dnf install -y fail2ban fail2ban-systemd
              elif [ "$DISTRO" = "debian" ]; then
                sudo apt-get update -qq
                sudo apt-get install -y fail2ban
              fi
              
              echo "âœ… Fail2ban instalado"
            fi
            echo ""

            # Get current IP for whitelist
            echo "ğŸ” Detectando IP para whitelist..."
            CURRENT_IP=""
            
            # Try to get IP from SSH connection
            if [ -n "$SSH_CLIENT" ]; then
              CURRENT_IP=$(echo $SSH_CLIENT | awk '{print $1}')
              echo "âœ… IP detectada desde SSH_CLIENT: $CURRENT_IP"
            else
              # Try to get public IP
              CURRENT_IP=$(curl -s --max-time 5 https://api.ipify.org 2>/dev/null || echo "")
              if [ -n "$CURRENT_IP" ]; then
                echo "âœ… IP pÃºblica detectada: $CURRENT_IP"
              else
                echo "âš ï¸  No se pudo detectar IP automÃ¡ticamente"
              fi
            fi
            
            # Build ignoreip list
            IGNOREIP="127.0.0.1/8 ::1"
            if [ -n "$CURRENT_IP" ]; then
              IGNOREIP="${IGNOREIP} ${CURRENT_IP}"
              echo "ğŸ“ IP agregada a whitelist: $CURRENT_IP"
            fi
            echo ""

            # Verify/create configuration
            echo "ğŸ“ Verificando configuraciÃ³n..."
            if [ ! -f /etc/fail2ban/jail.local ]; then
              echo "ğŸ“ Creando configuraciÃ³n /etc/fail2ban/jail.local..."
              
              sudo tee /etc/fail2ban/jail.local > /dev/null << EOF
            [DEFAULT]
            # Ban hosts for 10 minutes
            bantime = 10m
            
            # A host is banned if it has generated "maxretry" during the last "findtime"
            findtime = 10m
            
            # Number of failures before a host gets banned
            maxretry = 5
            
            # IPs to ignore (whitelist) - these will NEVER be banned
            ignoreip = ${IGNOREIP}
            
            # Action to take when banning
            action = %(action_)s
            
            [sshd]
            enabled = true
            port = ssh
            logpath = %(sshd_log)s
            backend = %(sshd_backend)s
            maxretry = 5
            bantime = 10m
            findtime = 10m
            # Whitelist applies to all jails
            ignoreip = ${IGNOREIP}
            
            # Optional: Protect against SSH DDoS
            [sshd-ddos]
            enabled = true
            port = ssh
            logpath = %(sshd_log)s
            maxretry = 10
            findtime = 10m
            bantime = 10m
            ignoreip = ${IGNOREIP}
            EOF
              
              echo "âœ… ConfiguraciÃ³n creada"
            else
              echo "âœ… ConfiguraciÃ³n ya existe en /etc/fail2ban/jail.local"
              echo "ğŸ“„ Contenido actual:"
              sudo cat /etc/fail2ban/jail.local | head -20
            fi
            echo ""

            # Enable and start service
            echo "ğŸ”„ Habilitando y reiniciando servicio..."
            sudo systemctl enable fail2ban
            sudo systemctl restart fail2ban
            
            # Wait for service to start
            sleep 3
            echo ""

            # Verify status
            echo "ğŸ“Š Verificando estado de Fail2ban..."
            if systemctl is-active --quiet fail2ban; then
              echo "âœ… Fail2ban estÃ¡ corriendo"
              echo ""
              
              echo "ğŸ“‹ Estado general:"
              sudo fail2ban-client status
              echo ""
              
              echo "ğŸ“‹ SSH Jail:"
              sudo fail2ban-client status sshd || echo "âš ï¸  SSH jail aÃºn no activo (normal si no hay actividad)"
              echo ""
              
              echo "ğŸ“‹ IPs baneadas actualmente:"
              sudo fail2ban-client get sshd banned 2>/dev/null || echo "  (ninguna)"
              echo ""
              
              # Show recent logs
              echo "ğŸ“‹ Ãšltimas lÃ­neas del log:"
              sudo tail -n 5 /var/log/fail2ban.log 2>/dev/null || echo "  (log aÃºn no generado)"
              echo ""
            else
              echo "âŒ Fail2ban no estÃ¡ corriendo"
              echo "ğŸ“‹ Logs de error:"
              sudo journalctl -u fail2ban -n 20 --no-pager
              exit 1
            fi

            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "âœ… FAIL2BAN INSTALACIÃ“N/VERIFICACIÃ“N COMPLETA"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "ğŸ“š Comandos Ãºtiles:"
            echo "  - Ver estado:        sudo fail2ban-client status"
            echo "  - Ver SSH jail:      sudo fail2ban-client status sshd"
            echo "  - Ver IPs baneadas:  sudo fail2ban-client get sshd banned"
            echo "  - Desbanear IP:      sudo fail2ban-client set sshd unbanip <IP>"
            echo "  - Ver logs:          sudo tail -f /var/log/fail2ban.log"
            echo ""
            echo "ğŸš¨ EMERGENCIA - Si te baneas accidentalmente:"
            echo "  1. Usa el workflow: 'Fail2ban Emergency Unban'"
            echo "  2. O desde el VPS: sudo /opt/codespartan/scripts/unban-ip.sh <TU_IP>"
            echo "  3. O desde el VPS: sudo /opt/codespartan/scripts/unban-ip.sh all"
            echo ""
            if [ -n "$CURRENT_IP" ]; then
              echo "âœ… Tu IP actual ($CURRENT_IP) estÃ¡ en la whitelist y NO serÃ¡ baneada"
            else
              echo "âš ï¸  No se pudo detectar tu IP. AgrÃ©galo manualmente a /etc/fail2ban/jail.local"
            fi
            echo ""

