services:
  db:
    image: postgres:16-alpine
    container_name: openproject-db
    restart: unless-stopped
    environment:
      POSTGRES_DB: "${POSTGRES_DB}"
      POSTGRES_USER: "${POSTGRES_USER}"
      POSTGRES_PASSWORD: "${POSTGRES_PASSWORD}"
    volumes:
      - openproject-db-data:/var/lib/postgresql/data
    networks:
      - openproject_internal
    deploy:
      resources:
        limits:
          cpus: '0.75'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U openproject"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  app:
    image: openproject/openproject:16
    container_name: openproject-app
    restart: unless-stopped
    depends_on:
      - db
      - cache
    environment:
      # Database configuration
      DATABASE_URL: "${DATABASE_URL}"

      # Rails configuration
      RAILS_CACHE_STORE: "memcache"
      OPENPROJECT_CACHE__MEMCACHE__SERVER: "cache:11211"
      RAILS_ENV: "production"
      RAILS_LOG_TO_STDOUT: "true"

      # OpenProject configuration
      OPENPROJECT_HOST__NAME: "${OPENPROJECT_HOST__NAME}"
      OPENPROJECT_HTTPS: "true"
      OPENPROJECT_DEFAULT__LANGUAGE: "${OPENPROJECT_DEFAULT__LANGUAGE}"

      # Email configuration
      OPENPROJECT_EMAIL__DELIVERY__METHOD: "${OPENPROJECT_EMAIL__DELIVERY__METHOD}"
      OPENPROJECT_SMTP__ADDRESS: "${OPENPROJECT_SMTP__ADDRESS}"
      OPENPROJECT_SMTP__PORT: "${OPENPROJECT_SMTP__PORT}"
      OPENPROJECT_SMTP__DOMAIN: "${OPENPROJECT_SMTP__DOMAIN}"
      OPENPROJECT_SMTP__AUTHENTICATION: "${OPENPROJECT_SMTP__AUTHENTICATION}"
      OPENPROJECT_SMTP__USER__NAME: "${OPENPROJECT_SMTP__USER__NAME}"
      OPENPROJECT_SMTP__PASSWORD: "${OPENPROJECT_SMTP__PASSWORD}"
      OPENPROJECT_SMTP__ENABLE__STARTTLS: "${OPENPROJECT_SMTP__ENABLE__STARTTLS}"

      # Security
      OPENPROJECT_SECRET__KEY__BASE: "${OPENPROJECT_SECRET__KEY__BASE}"

      # Advanced settings
      OPENPROJECT_ATTACHMENTS__STORAGE: "file"
    volumes:
      - openproject-data:/var/openproject/assets
      - openproject-attachments:/var/openproject/attachments
    networks:
      - web
      - openproject_internal
    deploy:
      resources:
        limits:
          cpus: '1.5'
          memory: 2.0G
        reservations:
          cpus: '0.5'
          memory: 512M
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/"]
      interval: 60s
      timeout: 10s
      retries: 5
      start_period: 600s  # 10 minutes for database migrations on first startup
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      - traefik.enable=true
      - traefik.http.routers.openproject.rule=Host(`${TRAEFIK_HOSTNAME}`)
      - traefik.http.routers.openproject.entrypoints=websecure
      - traefik.http.routers.openproject.tls=true
      - traefik.http.routers.openproject.tls.certresolver=le
      - traefik.http.services.openproject.loadbalancer.server.port=8080
      - traefik.docker.network=web

  cache:
    image: memcached:1.6-alpine
    container_name: openproject-cache
    restart: unless-stopped
    networks:
      - openproject_internal
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "11211"]
      interval: 30s
      timeout: 5s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  openproject-db-data:
    driver: local
  openproject-data:
    driver: local
  openproject-attachments:
    driver: local

networks:
  web:
    external: true
  openproject_internal:
    name: openproject_internal
    driver: bridge
    internal: true
    ipam:
      config:
        - subnet: 172.30.0.0/24
