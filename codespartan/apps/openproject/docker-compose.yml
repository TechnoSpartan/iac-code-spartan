services:
  db:
    image: postgres:15-alpine
    container_name: openproject-db
    restart: unless-stopped
    environment:
      POSTGRES_DB: openproject
      POSTGRES_USER: openproject
      POSTGRES_PASSWORD: openproject_secure_password_change_me
    volumes:
      - openproject-db-data:/var/lib/postgresql/data
    networks:
      - openproject_internal
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U openproject"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  app:
    image: openproject/openproject:14
    container_name: openproject-app
    restart: unless-stopped
    depends_on:
      - db
    environment:
      # Database configuration
      DATABASE_URL: "postgres://openproject:openproject_secure_password_change_me@db:5432/openproject?pool=20&encoding=unicode&reconnect=true"

      # Rails configuration
      RAILS_CACHE_STORE: "memcache"
      OPENPROJECT_CACHE__MEMCACHE__SERVER: "cache:11211"

      # OpenProject configuration
      OPENPROJECT_HOST__NAME: "project.cyberdyne-systems.es"
      OPENPROJECT_HTTPS: "true"
      OPENPROJECT_DEFAULT__LANGUAGE: "es"

      # Email configuration (configure with your SMTP settings)
      OPENPROJECT_EMAIL__DELIVERY__METHOD: "smtp"
      # OPENPROJECT_SMTP__ADDRESS: "smtp.example.com"
      # OPENPROJECT_SMTP__PORT: "587"
      # OPENPROJECT_SMTP__DOMAIN: "cyberdyne-systems.es"
      # OPENPROJECT_SMTP__AUTHENTICATION: "login"
      # OPENPROJECT_SMTP__USER__NAME: "noreply@cyberdyne-systems.es"
      # OPENPROJECT_SMTP__PASSWORD: "your-smtp-password"

      # Security
      OPENPROJECT_SECRET__KEY__BASE: "change-this-to-a-long-random-string-min-30-chars"
    volumes:
      - openproject-data:/var/openproject/assets
      - openproject-attachments:/var/openproject/attachments
    networks:
      - web
      - openproject_internal
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    healthcheck:
      test: ["CMD", "curl", "--fail", "--silent", "--show-error", "http://localhost:8080/health_checks/default"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 120s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      - traefik.enable=true
      - traefik.http.routers.openproject.rule=Host(`project.cyberdyne-systems.es`)
      - traefik.http.routers.openproject.entrypoints=websecure
      - traefik.http.routers.openproject.tls=true
      - traefik.http.routers.openproject.tls.certresolver=le
      - traefik.http.services.openproject.loadbalancer.server.port=8080
      - traefik.docker.network=web

  cache:
    image: memcached:1.6-alpine
    container_name: openproject-cache
    restart: unless-stopped
    networks:
      - openproject_internal
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "11211"]
      interval: 30s
      timeout: 5s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  openproject-db-data:
    driver: local
  openproject-data:
    driver: local
  openproject-attachments:
    driver: local

networks:
  web:
    external: true
  openproject_internal:
    name: openproject_internal
    driver: bridge
    internal: true
    ipam:
      config:
        - subnet: 172.26.0.0/24
