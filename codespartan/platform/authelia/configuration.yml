---
###############################################################################
#                           Authelia Configuration                           #
###############################################################################

# FASE 2: Single Sign-On with Multi-Factor Authentication
# This configuration provides centralized authentication for all dashboards

theme: dark

server:
  host: 0.0.0.0
  port: 9091
  path: ""
  enable_pprof: false
  enable_expvars: false

  # Asset path for custom branding (optional - disabled, directory doesn't exist)
  # asset_path: /config/assets/

  # Headers sent to backend
  headers:
    csp_template: ""

log:
  level: info
  format: text
  file_path: /data/authelia.log

# TOTP (Time-based One-Time Password) configuration
totp:
  disable: false
  issuer: mambo-cloud.com
  algorithm: sha1
  digits: 6
  period: 30
  skew: 1
  secret_size: 32

# WebAuthn (hardware keys like YubiKey - optional)
webauthn:
  disable: true  # Set to false if you want to enable hardware keys
  timeout: 60s
  display_name: Mambo Cloud
  attestation_conveyance_preference: indirect
  user_verification: preferred

# Duo Push (optional - requires Duo account)
duo_api:
  disable: true
  hostname: api-XXXXXXXX.duosecurity.com
  integration_key: YOUR_INTEGRATION_KEY
  secret_key: YOUR_SECRET_KEY
  enable_self_enrollment: false

# Identity Validation
identity_validation:
  reset_password:
    jwt_secret: insecure_jwt_secret_please_change_in_production

# Authentication backend
authentication_backend:
  password_reset:
    disable: false
    custom_url: ""

  refresh_interval: 5m

  file:
    path: /config/users_database.yml
    password:
      algorithm: argon2
      argon2:
        variant: argon2id
        iterations: 3
        memory: 65536
        parallelism: 4
        key_length: 32
        salt_length: 16

# Access Control Rules
access_control:
  default_policy: deny

  rules:
    # Allow Authelia portal itself
    - domain: auth.mambo-cloud.com
      policy: bypass

    # Dashboards - require authentication + MFA
    - domain:
        - traefik.mambo-cloud.com
        - grafana.mambo-cloud.com
        - backoffice.mambo-cloud.com
      policy: two_factor
      subject:
        - "group:admins"

    # Public apps - no auth required
    - domain:
        - www.mambo-cloud.com
        - staging.mambo-cloud.com
        - www.cyberdyne-systems.es
        - staging.cyberdyne-systems.es
        - www.dental-io.com
      policy: bypass

# Session configuration
session:
  name: authelia_session
  domain: mambo-cloud.com  # Root domain for SSO
  same_site: lax
  secret: insecure_session_secret  # CHANGE IN PRODUCTION
  expiration: 1h
  inactivity: 5m
  remember_me_duration: 1M

  redis:
    host: authelia-redis
    port: 6379
    username: ""
    password: ""
    database_index: 0
    maximum_active_connections: 8
    minimum_idle_connections: 0

# Session storage (Redis for performance)
regulation:
  max_retries: 3
  find_time: 2m
  ban_time: 5m

# Storage backend (SQLite for simplicity)
storage:
  encryption_key: insecure_encryption_key  # CHANGE IN PRODUCTION (min 20 chars)

  local:
    path: /data/db.sqlite3

# Notification Provider (file-based for now)
notifier:
  disable_startup_check: false

  filesystem:
    filename: /data/notifications.txt

  # SMTP configuration (Hostinger) - DISABLED until we test file-based works
  # smtp:
  #   host: smtp.hostinger.com
  #   port: 465
  #   timeout: 5s
  #   username: iam@codespartan.es
  #   password: Codespartan$2
  #   sender: "Mambo Cloud Auth <noreply@codespartan.es>"
  #   identifier: mambo-cloud.com
  #   subject: "[Mambo Cloud] {title}"
  #   startup_check_address: iam@codespartan.es
  #   disable_require_tls: false
  #   disable_html_emails: false
  #   tls:
  #     server_name: smtp.hostinger.com
  #     skip_verify: false

# NTP configuration (for TOTP accuracy)
ntp:
  address: time.cloudflare.com:123
  version: 4
  max_desync: 3s
  disable_startup_check: false
  disable_failure: false

# OpenID Connect / OAuth 2.0 Provider
identity_providers:
  oidc:
    hmac_secret: RbLkGnkJy/aRM+B3VczDpN9M3wMIhYTdpccEFPCDJGIedRnS/m50ulrjcYWCmEd/tymmgN+Mm0FXcR5lG5xcTw==

    # JWKS configuration with RSA key for signing
    jwks:
      - algorithm: RS256
        use: sig
        key: |
          -----BEGIN PRIVATE KEY-----
          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
          IVkRtFS/1mojp/D+ve/PziCG61G5lA==
          -----END PRIVATE KEY-----

    access_token_lifespan: 1h
    authorize_code_lifespan: 1m
    id_token_lifespan: 1h
    refresh_token_lifespan: 90m
    enable_client_debug_messages: false
    enforce_pkce: public_clients_only

    cors:
      endpoints:
        - authorization
        - token
        - revocation
        - introspection
        - userinfo
      allowed_origins_from_client_redirect_uris: true

    clients:
      - id: grafana
        description: Grafana Dashboard
        secret: 'tBVp0E9iP9KDuaR/JbjHT6QpV4+yWiirtjdSzFCEzUs='
        public: false
        authorization_policy: two_factor
        redirect_uris:
          - https://grafana.mambo-cloud.com/login/generic_oauth
        scopes:
          - openid
          - profile
          - email
          - groups
        userinfo_signing_algorithm: none
        token_endpoint_auth_method: client_secret_basic
