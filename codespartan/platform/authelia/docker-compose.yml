services:
  authelia:
    image: authelia/authelia:latest
    container_name: authelia
    volumes:
      - ./configuration.yml:/config/configuration.yml
      - ./users_database.yml:/config/users_database.yml
      - authelia_data:/data
    networks:
      - web
      - authelia_internal
    labels:
      - traefik.enable=true

      # Router for Authelia portal
      - traefik.http.routers.authelia.rule=Host(`auth.mambo-cloud.com`)
      - traefik.http.routers.authelia.entrypoints=websecure
      - traefik.http.routers.authelia.tls=true
      - traefik.http.routers.authelia.tls.certresolver=le
      - traefik.http.routers.authelia.service=authelia
      - traefik.http.services.authelia.loadbalancer.server.port=9091
      - traefik.http.services.authelia.loadbalancer.passhostheader=true

      # Middleware definition
      - traefik.http.middlewares.authelia.forwardAuth.address=http://authelia:9091/api/verify?rd=https://auth.mambo-cloud.com
      - traefik.http.middlewares.authelia.forwardAuth.trustForwardHeader=true
      - traefik.http.middlewares.authelia.forwardAuth.authResponseHeaders=Remote-User,Remote-Groups,Remote-Name,Remote-Email

      # Security headers
      - traefik.http.routers.authelia.middlewares=security-headers@file

      # Specify which Docker network Traefik should use
      - traefik.docker.network=web

    environment:
      - TZ=Europe/Madrid

    restart: unless-stopped

    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M

    # Healthcheck disabled - Authelia container has minimal tools (no wget/curl/pgrep)
    # Container runs successfully without healthcheck, monitored via Loki/Grafana instead
    # healthcheck:
    #   test: ["CMD-SHELL", "pgrep authelia || exit 1"]
    #   interval: 30s
    #   timeout: 5s
    #   retries: 3
    #   start_period: 30s

    depends_on:
      authelia-redis:
        condition: service_healthy

  authelia-redis:
    image: redis:7-alpine
    container_name: authelia-redis
    command: redis-server --save 60 1 --loglevel warning
    volumes:
      - authelia_redis:/data
    networks:
      - authelia_internal
    restart: unless-stopped

    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 128M
        reservations:
          cpus: '0.05'
          memory: 32M

    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 10s

volumes:
  authelia_data:
    name: authelia_data
  authelia_redis:
    name: authelia_redis

networks:
  web:
    external: true
  authelia_internal:
    name: authelia_internal
    driver: bridge
    internal: true  # Redis solo accesible por Authelia
    ipam:
      config:
        - subnet: 172.21.0.0/24
